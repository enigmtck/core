import{S as Ze,i as $e,s as et,n as _e,d as c,b as B,o,e as p,f as w,h as H,r as Ae,j as m,k as V,l as Oe,u as tt,v as lt,w as st,x as Ee,c as u,m as F,y as pe,z as nt,A as at,B as Ne,C as Le,D as He,E as Ie,a as ze,g as We,t as Xe,F as Ke,H as Qe}from"./DR2rOELM.js";import{e as Ve,r as Fe,c as Be,i as Pe}from"./CV3kTBDU.js";import"./IHki7fMi.js";import{s as it,a as rt}from"./B-rSUPNY.js";import{a as ot,e as ct}from"./B4kYsGbE.js";function Ue(l,e,t){const s=l.slice();return s[48]=e[t],s}function je(l){let e,t,s,n,i,r,h,g,v,P,E,b,_,se,U,ne,X,S,y,R,M,Z,Q,z,$,ve=`<i class="fa-solid fa-at svelte-1xg1hln"></i> <div class="svelte-1xg1hln"><h1 class="svelte-1xg1hln">Direct</h1> <span class="svelte-1xg1hln">This note will be visible to mentioned people only. If possible (i.e., if to a
										single recipient who has Enigmatick encryption capabilities), the message will
										be end-to-end encrypted.</span></div>`,me,q,ke='<i class="fa-solid fa-earth-americas svelte-1xg1hln"></i> <div class="svelte-1xg1hln"><h1 class="svelte-1xg1hln">Public</h1> <span class="svelte-1xg1hln">This note will be visible to all viewers.</span></div>',ae,ee,te,ue,D=l[4]&&l[3]&&Ge(l),T=l[2]&&qe(l),J=Ve(Array.from(l[6].values())),N=[];for(let d=0;d<J.length;d+=1)N[d]=Je(Ue(l,J,d));function j(d,I){return d[2]?dt:ht}let ie=j(l),W=ie(l);function be(d,I){return d[0]?pt:gt}let he=be(l),Y=he(l);return{c(){e=m("div"),t=m("i"),s=V(),n=m("div"),D&&D.c(),i=V(),r=m("div"),h=V(),T&&T.c(),g=V(),v=m("section");for(let d=0;d<N.length;d+=1)N[d].c();P=V(),E=m("form"),b=m("div"),_=m("i"),se=V(),U=m("input"),ne=V(),W.c(),X=V(),S=m("div"),y=m("i"),R=V(),M=m("div"),Y.c(),Z=V(),Q=m("div"),z=m("ul"),$=m("li"),$.innerHTML=ve,me=V(),q=m("li"),q.innerHTML=ke,this.h()},l(d){e=p(d,"DIV",{class:!0});var I=w(e);t=p(I,"I",{class:!0}),w(t).forEach(c),s=H(I),n=p(I,"DIV",{class:!0});var C=w(n);D&&D.l(C),i=H(C),r=p(C,"DIV",{class:!0,contenteditable:!0}),w(r).forEach(c),C.forEach(c),h=H(I),T&&T.l(I),g=H(I),v=p(I,"SECTION",{class:!0});var oe=w(v);for(let A=0;A<N.length;A+=1)N[A].l(oe);oe.forEach(c),P=H(I),E=p(I,"FORM",{method:!0,class:!0});var le=w(E);b=p(le,"DIV",{class:!0});var de=w(b);_=p(de,"I",{class:!0}),w(_).forEach(c),se=H(de),U=p(de,"INPUT",{style:!0,type:!0,accept:!0,class:!0}),de.forEach(c),ne=H(le),W.l(le),X=H(le),S=p(le,"DIV",{class:!0});var a=w(S);y=p(a,"I",{class:!0}),w(y).forEach(c),a.forEach(c),R=H(le),M=p(le,"DIV",{class:!0});var f=w(M);Y.l(f),Z=H(f),Q=p(f,"DIV",{class:!0});var k=w(Q);z=p(k,"UL",{class:!0});var O=w(z);$=p(O,"LI",{class:!0,"data-svelte-h":!0}),Ne($)!=="svelte-lt5tui"&&($.innerHTML=ve),me=H(O),q=p(O,"LI",{class:!0,"data-svelte-h":!0}),Ne(q)!=="svelte-3el1o1"&&(q.innerHTML=ke),O.forEach(c),k.forEach(c),f.forEach(c),le.forEach(c),I.forEach(c),this.h()},h(){o(t,"class","fa-solid fa-xmark svelte-1xg1hln"),o(r,"class","entry svelte-1xg1hln"),o(r,"contenteditable","true"),l[11]===void 0&&nt(()=>l[28].call(r)),o(n,"class","compose-container svelte-1xg1hln"),o(v,"class","svelte-1xg1hln"),o(_,"class","fa-solid fa-paperclip svelte-1xg1hln"),at(U,"display","none"),o(U,"type","file"),o(U,"accept",".jpg, .jpeg, .png"),o(U,"class","svelte-1xg1hln"),o(b,"class","svelte-1xg1hln"),o(y,"class","fa-regular fa-paper-plane svelte-1xg1hln"),o(S,"class","svelte-1xg1hln"),o($,"class","svelte-1xg1hln"),o(q,"class","svelte-1xg1hln"),o(z,"class","svelte-1xg1hln"),o(Q,"class","svelte-1xg1hln"),o(M,"class",ae=Ee(l[8]?"privacy":"")+" svelte-1xg1hln"),o(E,"method","POST"),o(E,"class","svelte-1xg1hln"),o(e,"class",ee=Ee(l[0]&&!l[4]?"direct":"")+" svelte-1xg1hln")},m(d,I){B(d,e,I),u(e,t),u(e,s),u(e,n),D&&D.m(n,null),u(n,i),u(n,r),l[26](r),l[11]!==void 0&&(r.innerText=l[11]),u(e,h),T&&T.m(e,null),u(e,g),u(e,v);for(let C=0;C<N.length;C+=1)N[C]&&N[C].m(v,null);u(e,P),u(e,E),u(E,b),u(b,_),u(b,se),u(b,U),l[32](U),u(E,ne),W.m(E,null),u(E,X),u(E,S),u(S,y),u(E,R),u(E,M),Y.m(M,null),u(M,Z),u(M,Q),u(Q,z),u(z,$),u(z,me),u(z,q),te||(ue=[F(t,"click",l[13]),F(r,"keyup",l[20]),F(r,"focusout",l[27]),F(r,"input",l[28]),F(_,"keyup",l[29]),F(_,"click",l[30]),F(U,"change",l[31]),F(y,"click",pe(l[16])),F($,"click",l[33]),F(q,"click",l[34]),F(M,"click",l[35]),F(E,"submit",pe(kt))],te=!0)},p(d,I){if(d[4]&&d[3]?D?D.p(d,I):(D=Ge(d),D.c(),D.m(n,i)):D&&(D.d(1),D=null),I[0]&2048&&d[11]!==r.innerText&&(r.innerText=d[11]),d[2]?T?T.p(d,I):(T=qe(d),T.c(),T.m(e,g)):T&&(T.d(1),T=null),I[0]&262208){J=Ve(Array.from(d[6].values()));let C;for(C=0;C<J.length;C+=1){const oe=Ue(d,J,C);N[C]?N[C].p(oe,I):(N[C]=Je(oe),N[C].c(),N[C].m(v,null))}for(;C<N.length;C+=1)N[C].d(1);N.length=J.length}ie===(ie=j(d))&&W?W.p(d,I):(W.d(1),W=ie(d),W&&(W.c(),W.m(E,X))),he!==(he=be(d))&&(Y.d(1),Y=he(d),Y&&(Y.c(),Y.m(M,Z))),I[0]&256&&ae!==(ae=Ee(d[8]?"privacy":"")+" svelte-1xg1hln")&&o(M,"class",ae),I[0]&17&&ee!==(ee=Ee(d[0]&&!d[4]?"direct":"")+" svelte-1xg1hln")&&o(e,"class",ee)},d(d){d&&c(e),D&&D.d(),l[26](null),T&&T.d(),lt(N,d),l[32](null),W.d(),Y.d(),te=!1,st(ue)}}}function Ge(l){let e,t,s,n,i,r,h,g,v,P=Fe(l[4].note.content)+"",E,b,_,se,U;function ne(y,R){return y[3]&&y[3].name?ut:ft}let X=ne(l),S=X(l);return{c(){e=m("div"),t=m("div"),s=m("div"),n=m("img"),r=V(),h=m("span"),S.c(),g=V(),v=m("span"),E=Xe(P),b=V(),_=m("i"),this.h()},l(y){e=p(y,"DIV",{class:!0});var R=w(e);t=p(R,"DIV",{class:!0});var M=w(t);s=p(M,"DIV",{class:!0});var Z=w(s);n=p(Z,"IMG",{src:!0,alt:!0,class:!0}),Z.forEach(c),r=H(M),h=p(M,"SPAN",{class:!0});var Q=w(h);S.l(Q),Q.forEach(c),M.forEach(c),g=H(R),v=p(R,"SPAN",{class:!0});var z=w(v);E=We(z,P),z.forEach(c),b=H(R),_=p(R,"I",{class:!0}),w(_).forEach(c),R.forEach(c),this.h()},h(){var y;Ie(n.src,i=Be(l[12],String((y=l[3].icon)==null?void 0:y.url)))||o(n,"src",i),o(n,"alt","Avatar"),o(n,"class","svelte-1xg1hln"),o(s,"class","svelte-1xg1hln"),o(h,"class","svelte-1xg1hln"),o(t,"class","actor svelte-1xg1hln"),o(v,"class","svelte-1xg1hln"),o(_,"class","fa-solid fa-xmark svelte-1xg1hln"),o(e,"class","reply svelte-1xg1hln")},m(y,R){B(y,e,R),u(e,t),u(t,s),u(s,n),u(t,r),u(t,h),S.m(h,null),u(e,g),u(e,v),u(v,E),u(e,b),u(e,_),se||(U=F(_,"click",pe(l[15])),se=!0)},p(y,R){var M;R[0]&4104&&!Ie(n.src,i=Be(y[12],String((M=y[3].icon)==null?void 0:M.url)))&&o(n,"src",i),X===(X=ne(y))&&S?S.p(y,R):(S.d(1),S=X(y),S&&(S.c(),S.m(h,null))),R[0]&16&&P!==(P=Fe(y[4].note.content)+"")&&ze(E,P)},d(y){y&&c(e),S.d(),se=!1,U()}}}function ft(l){var s;let e=((s=l[3])==null?void 0:s.preferredUsername)+"",t;return{c(){t=Xe(e)},l(n){t=We(n,e)},m(n,i){B(n,t,i)},p(n,i){var r;i[0]&8&&e!==(e=((r=n[3])==null?void 0:r.preferredUsername)+"")&&ze(t,e)},d(n){n&&c(t)}}}function ut(l){let e,t=Pe(l[12],l[3].name,l[3])+"",s;return{c(){e=new Qe(!1),s=Ae(),this.h()},l(n){e=Ke(n,!1),s=Ae(),this.h()},h(){e.a=s},m(n,i){e.m(t,n,i),B(n,s,i)},p(n,i){i[0]&4104&&t!==(t=Pe(n[12],n[3].name,n[3])+"")&&e.p(t)},d(n){n&&(c(s),e.d())}}}function qe(l){let e,t;return{c(){e=m("div"),t=new Qe(!1),this.h()},l(s){e=p(s,"DIV",{class:!0});var n=w(e);t=Ke(n,!1),n.forEach(c),this.h()},h(){t.a=null,o(e,"class","preview svelte-1xg1hln")},m(s,n){B(s,e,n),t.m(l[10],e)},p(s,n){n[0]&1024&&t.p(s[10])},d(s){s&&c(e)}}}function Je(l){let e,t,s,n,i,r,h,g,v,P,E;return{c(){e=m("div"),t=m("img"),r=V(),h=m("i"),v=V(),this.h()},l(b){e=p(b,"DIV",{class:!0});var _=w(e);t=p(_,"IMG",{src:!0,width:!0,height:!0,class:!0}),r=H(_),h=p(_,"I",{class:!0,"data-url":!0}),w(h).forEach(c),v=H(_),_.forEach(c),this.h()},h(){Ie(t.src,s=l[48].url)||o(t,"src",s),o(t,"width",n=l[48].width),o(t,"height",i=l[48].height),o(t,"class","svelte-1xg1hln"),o(h,"class","fa-solid fa-xmark svelte-1xg1hln"),o(h,"data-url",g=l[48].url),o(e,"class","svelte-1xg1hln")},m(b,_){B(b,e,_),u(e,t),u(e,r),u(e,h),u(e,v),P||(E=F(h,"click",pe(l[18])),P=!0)},p(b,_){_[0]&64&&!Ie(t.src,s=b[48].url)&&o(t,"src",s),_[0]&64&&n!==(n=b[48].width)&&o(t,"width",n),_[0]&64&&i!==(i=b[48].height)&&o(t,"height",i),_[0]&64&&g!==(g=b[48].url)&&o(h,"data-url",g)},d(b){b&&c(e),P=!1,E()}}}function ht(l){let e,t,s,n;return{c(){e=m("div"),t=m("i"),this.h()},l(i){e=p(i,"DIV",{class:!0});var r=w(e);t=p(r,"I",{class:!0}),w(t).forEach(c),r.forEach(c),this.h()},h(){o(t,"class","fa-solid fa-eye svelte-1xg1hln"),o(e,"class","svelte-1xg1hln")},m(i,r){B(i,e,r),u(e,t),s||(n=F(t,"click",pe(l[14])),s=!0)},p:_e,d(i){i&&c(e),s=!1,n()}}}function dt(l){let e,t,s,n;return{c(){e=m("div"),t=m("i"),this.h()},l(i){e=p(i,"DIV",{class:!0});var r=w(e);t=p(r,"I",{class:!0}),w(t).forEach(c),r.forEach(c),this.h()},h(){o(t,"class","fa-solid fa-pen-nib svelte-1xg1hln"),o(e,"class","svelte-1xg1hln")},m(i,r){B(i,e,r),u(e,t),s||(n=F(t,"click",pe(l[14])),s=!0)},p:_e,d(i){i&&c(e),s=!1,n()}}}function gt(l){let e;return{c(){e=m("i"),this.h()},l(t){e=p(t,"I",{class:!0}),w(e).forEach(c),this.h()},h(){o(e,"class","fa-solid fa-earth-americas svelte-1xg1hln")},m(t,s){B(t,e,s)},d(t){t&&c(e)}}}function pt(l){let e;return{c(){e=m("i"),this.h()},l(t){e=p(t,"I",{class:!0}),w(e).forEach(c),this.h()},h(){o(e,"class","fa-solid fa-at svelte-1xg1hln")},m(t,s){B(t,e,s)},d(t){t&&c(e)}}}function xe(l){let e,t='<i class="fa-solid fa-pencil svelte-1xg1hln"></i>',s,n;return{c(){e=m("div"),e.innerHTML=t,this.h()},l(i){e=p(i,"DIV",{class:!0,"data-svelte-h":!0}),Ne(e)!=="svelte-p2i4o9"&&(e.innerHTML=t),this.h()},h(){o(e,"class","compose svelte-1xg1hln")},m(i,r){B(i,e,r),s||(n=F(e,"click",Te),s=!0)},p:_e,d(i){i&&c(e),s=!1,n()}}}function mt(l){let e,t,s,n,i,r=l[9]&&je(l),h=l[9]&&xe();return{c(){e=m("div"),t=V(),s=m("dialog"),r&&r.c(),n=V(),h&&h.c(),i=Ae(),this.h()},l(g){e=p(g,"DIV",{class:!0}),w(e).forEach(c),t=H(g),s=p(g,"DIALOG",{class:!0});var v=w(s);r&&r.l(v),v.forEach(c),n=H(g),h&&h.l(g),i=Ae(),this.h()},h(){o(e,"class","mask closed svelte-1xg1hln"),o(s,"class","svelte-1xg1hln")},m(g,v){B(g,e,v),B(g,t,v),B(g,s,v),r&&r.m(s,null),B(g,n,v),h&&h.m(g,v),B(g,i,v)},p(g,v){g[9]?r?r.p(g,v):(r=je(g),r.c(),r.m(s,null)):r&&(r.d(1),r=null),g[9]?h?h.p(g,v):(h=xe(),h.c(),h.m(i.parentNode,i)):h&&(h.d(1),h=null)},i:_e,o:_e,d(g){g&&(c(e),c(t),c(s),c(n),c(i)),r&&r.d(),h&&h.d(g)}}}const _t=/@(\w+)@([\w-]+\.[\w-]+(?:\.[\w-]+)*)/,vt=/#\w+/;function Te(){document.getElementsByTagName("dialog")[0].showModal(),document.getElementsByClassName("mask")[0].classList.remove("closed")}function kt(l){console.log(l)}function bt(l){let e="";if(window.getSelection){const s=window.getSelection();if(s&&s.rangeCount>0){const n=s.getRangeAt(0),i=n.cloneRange();i.selectNodeContents(l),i.setEnd(n.startContainer,n.startOffset),e=i.toString()}}const t=e.trim().split(/\s+/);return t[t.length-1]||""}function wt(l,e,t){let s,n,i,r,h,g;Oe(l,ot,a=>t(24,h=a)),Oe(l,ct,a=>t(25,g=a));const{Converter:v}=it,P=tt();let{senderFunction:E}=e,{direct:b}=e,_=null;async function se(a){console.log("IN COMPOSE"),console.log(a),_=a.detail.parentArticle,t(3,ee=a.detail.replyToActor),t(4,te=a.detail.replyToNote),te.note.type=="EncryptedNote"?t(0,b=!0):te.isPublic()&&t(0,b=!1),a.detail.openAside&&Te();let f=await(s==null?void 0:s.get_webfinger_from_id(ee.id));t(11,n=`${f} `),t(10,i=ne(n)),await Le(),j&&q(!0),console.debug("Compose parentArticle"),console.debug(_)}function U(){y(),document.getElementsByTagName("dialog")[0].close(),document.getElementsByClassName("mask")[0].classList.add("closed")}function ne(a){let f=new v({extensions:[rt({pre:!0,auto_detection:!0})]});return f.setFlavor("vanilla"),f.setOption("tables",!0),f.setOption("requireSpaceBeforeHeadingText",!0),f.makeHtml(a)}function X(){j&&(t(11,n=j.innerText),t(10,i=ne(n).replace(`
`,"")))}async function S(){X(),t(2,ae=!ae),await Le(),j&&q(!0)}function y(){R(),t(2,ae=!1),t(11,n=""),t(10,i=""),J.clear(),N.clear()}function R(){t(4,te=null),t(3,ee=null)}async function M(){X();let a=ve(i);a=$(a),E(ee,te,a,Array.from(T.values()),new Map(Array.from(J.entries()).filter(([f,k])=>k!==null&&k.id!==void 0).map(([f,k])=>[f,k])),Array.from(N),b).then(async f=>{if(f){y(),U();let k=JSON.parse(f);P("publish",{activity:k}),console.log(k),console.log("send successful"),console.log("parentArticle in senderFunction"),console.log(_),_&&typeof _.loadReplies=="function"&&await _.loadReplies()}else console.log("send unsuccessful")})}const Z=a=>{let f=a.target;if(f.files!==null){let k=f.files[0];String(k.name.match(/\.[0-9a-z]+$/i)).slice(1);let O=new FileReader;O.readAsArrayBuffer(k),O.onload=A=>{if(A.target!==null){ue=A.target.result!==null?A.target.result:null;let L=new Uint8Array(ue);s==null||s.upload_image(L,ue.byteLength).then(G=>{if(console.log("IMAGE UPLOADED"),G){let x=JSON.parse(G);x.url&&(T.set(x.url,x),t(6,T),console.debug(T))}})}}}},Q=a=>{if(a.target&&a.target instanceof HTMLElement&&a.target.dataset.url){const f=a.target.dataset.url;T.delete(f),t(6,T)}},z=a=>{const f=/#\w+/g;return a.replace(f,k=>(N.add(k),`<span class="hashtag transient">${k}</span>`))},$=a=>{const f=/#\w+/g,k=a.matchAll(f),O=s==null?void 0:s.get_state().get_server_url();for(const A of k){const L=A[0],G=`${O}/tags/${L.replace("#","")}`;N.has(L)&&(a=a.replaceAll(L,`<a href="${G}">${L}</a>`))}return a},ve=a=>{const f=/@(\w+)@([\w-]+\.[\w-]+(?:\.[\w-]+)*)/g,k=a.matchAll(f);for(const O of k){const A=O[0];let L=J.get(A);L&&(a=a.replaceAll(A,`<span class="h-card"><a href="${L.url}" class="u-url mention" rel="noopener noreferrer">@${L.preferredUsername}</a></span>`))}return a},me=a=>{const f=/@(\w+)@([\w-]+\.[\w-]+(?:\.[\w-]+)*)/g;return new Promise(async(k,O)=>{try{const A=a.matchAll(f);for(const G of A){const x=G[0];if(J.get(x)===void 0)try{let re=JSON.parse(await(s==null?void 0:s.get_actor_from_webfinger_promise(x)));J.set(x,re)}catch{console.error("Failed to retrieve actor"),J.set(x,null);continue}}const L=a.replace(f,(G,x,re)=>{var ye;let ce=J.get(G),we="";return(ye=ce==null?void 0:ce.capabilities)!=null&&ye.enigmatickEncryption&&(we='<i class="fa-solid fa-lock transient"></i>'),ce?`<span contenteditable="false" class="mention transient">${we}${G}</span>`:G});k(L)}catch(A){O(A)}})},q=async a=>{var Se,Re;if(!a){let K=bt(j);if(!K.match(_t)&&!K.match(vt))return}const f=window.getSelection(),k=f==null?void 0:f.getRangeAt(0),O=(k==null?void 0:k.startOffset)||0,A=k==null?void 0:k.startContainer;let L=O,G=A==null?void 0:A.previousSibling;for(;G;)L+=((Se=G.textContent)==null?void 0:Se.length)||0,G=G.previousSibling;let x="",re=!0;function ce(K){for(let ge=0;ge<K.length;ge++){const fe=K[ge];fe.nodeName==="BR"?(x+=`
`,re=!0):fe.nodeName==="DIV"&&!re&&(x+=`
`,re=!1),fe.nodeType===3&&fe.textContent&&(x+=fe.textContent,re=!1),fe.childNodes.length>0&&ce(fe.childNodes)}}ce(j.childNodes);const we=await me(x.replace(/</g,"&lt;").replace(/>/g,"&gt;")),ye=z(we);t(7,j.innerHTML=ye,j);const Ye=Array.from(j.childNodes);let Ce=0,De=null,Me=0;for(const K of Ye){const ge=((Re=K.textContent)==null?void 0:Re.length)||0;if(Ce+ge>=L){De=K,Me=L-Ce;break}Ce+=ge}if(f&&De){const K=document.createRange();f.removeAllRanges(),K.setStart(De,Me),K.collapse(!0),f.addRange(K)}},ke=async a=>{var f;switch(a.key){case" ":q(!1),a.preventDefault();break;case"Backspace":const k=window.getSelection();if(k){const O=k.getRangeAt(0);if(O){const A=O.startContainer,L=A.nodeType===Node.TEXT_NODE?(f=A.parentElement)==null?void 0:f.closest("span"):A instanceof Element?A.closest("span"):null;L&&O.collapsed&&A.textContent&&O.startOffset===A.textContent.length&&(a.preventDefault(),L.remove())}}break}};let ae=!1,ee=null,te=null,ue,D,T=new Map,J=new Map,N=new Set,j,ie=!1;function W(a){He[a?"unshift":"push"](()=>{j=a,t(7,j)})}const be=a=>{q(!0)};function he(){n=this.innerText,t(11,n)}const Y=()=>{D.click()},d=()=>{D.click()},I=a=>Z(a);function C(a){He[a?"unshift":"push"](()=>{D=a,t(5,D)})}const oe=()=>{t(0,b=!0)},le=()=>{t(0,b=!1)},de=()=>{t(8,ie=!ie)};return l.$$set=a=>{"senderFunction"in a&&t(21,E=a.senderFunction),"direct"in a&&t(0,b=a.direct)},l.$$.update=()=>{l.$$.dirty[0]&33554432&&t(12,s=g),l.$$.dirty[0]&16777216&&t(9,r=h.username)},t(11,n=""),t(10,i=""),[b,Te,ae,ee,te,D,T,j,ie,r,i,n,s,U,S,R,M,Z,Q,q,ke,E,se,y,h,g,W,be,he,Y,d,I,C,oe,le,de]}class Ct extends Ze{constructor(e){super(),$e(this,e,wt,mt,et,{senderFunction:21,direct:0,handleReplyToMessage:22,openAside:1,resetCompose:23},null,[-1,-1])}get handleReplyToMessage(){return this.$$.ctx[22]}get openAside(){return Te}get resetCompose(){return this.$$.ctx[23]}}export{Ct as C};
