import"../chunks/CWj6FrbW.js";import{aL as Pe,p as He,o as De,aD as ke,I as k,A as s,E as o,aC as f,S as ue,aJ as y,w as Oe,aH as J,z as U,aE as Ye,y as V,a as je,ap as w,aI as O,D as B,aM as me}from"../chunks/CPBLXjHw.js";import{i as fe}from"../chunks/DQNDscH3.js";import{e as pe,i as we}from"../chunks/J1mst6rE.js";import{s as Ce}from"../chunks/DSGZP5v2.js";import{b as he}from"../chunks/CD7duDpS.js";import{a as T,s as Le}from"../chunks/DmKqPpxj.js";import{C as Ze,P as Re}from"../chunks/B4BXaNBM.js";import{u as Ie,P as We}from"../chunks/CWFKWbqW.js";import{b as Fe,g as Je}from"../chunks/2w9f54dl.js";import{h as ge,e as Ue,a as Ve}from"../chunks/CS4B0N_g.js";import"../chunks/DNlpqXoR.js";import{d as Be,s as ve,f as Ke,D as Ne,h as Qe}from"../chunks/CR2iVpIj.js";import{p as qe}from"../chunks/DfJuBoyc.js";import{H as Ge}from"../chunks/CKBTCsS-.js";var Xe=Oe('<!> <!> <main class="svelte-1fjec68"><div><div class="content-scroll svelte-1fjec68"><div class="scroll svelte-1fjec68" role="button" tabindex="0"><i class="fa-solid fa-chevron-up svelte-1fjec68"></i></div> <!> <!></div></div></main>',1);function wt(ye,be){He(be,!0);const _e=()=>T(Ue,"$enigmatickWasm",b),Y=()=>T(qe,"$page",b),K=()=>T(ge,"$hashtags",b),N=()=>T(Ee,"$isSmallScreen",b),Te=()=>T(Ve,"$appData",b),[b,$e]=Le();let $=f(void 0),c=f(""),p=y(_e);const Ee=Ie("(max-width: 1200px)");De(async()=>{s(X,!0),window.addEventListener("scroll",q),window.addEventListener("scroll",ae);const e=()=>{const n=document.body.scrollHeight;document.documentElement.scrollHeight<n&&(document.documentElement.style.height=`${n}px`,document.documentElement.style.minHeight=`${n}px`)};e(),E=new ResizeObserver(()=>{e()}),document.body&&E.observe(document.body),A=new MutationObserver(()=>{e()}),document.body&&A.observe(document.body,{childList:!0,subtree:!0});const t=Y().url.searchParams.get("view");t&&["home","local","direct","global"].includes(t)?s(c,t,!0):o(H)?s(c,"home"):s(c,"global"),await w(),await C(),await w(),e()});let E=null,A=null;ke(()=>{window.removeEventListener("scroll",q),window.removeEventListener("scroll",ae),E&&E.disconnect(),A&&A.disconnect()});const Ae=async e=>{if(console.debug(`Placing ${e.note.id}`),!e.note.inReplyTo&&e.note.id){o(l).has(e.note.id)||s(l,new Map(o(l)).set(e.note.id,e),!0),await j(!0,0);return}const t=n=>{for(const[,a]of n.entries()){if(a.note.id===e.note.inReplyTo&&e.note.id)return a.replies.has(e.note.id)||a.replies.set(e.note.id,e),!0;if(t(a.replies))return!0}return!1};if(e.note.inReplyTo&&t(o(l))){s(l,new Map(o(l)),!0),await j(!1);return}await j(!1)},j=async(e,t)=>{try{let n=oe;if(s(l,o(l),!0),e&&t){for(let a=0;a<t;a++)await w();window.scrollTo({top:n,left:0,behavior:"instant"}),document.documentElement.scrollTop=n,document.body.scrollTop=n}}catch(n){console.error(n)}},Q=async e=>{var n;if(typeof e.object=="string")return;const t=e.object;if(console.debug(`Adding ${t.id}`),console.debug(t),"attributedTo"in t&&t.attributedTo){console.debug(`Attributed to ${(n=t.ephemeral)==null?void 0:n.attributedTo}`);const a=Ke("ephemeral"in t&&t.ephemeral?t.ephemeral.attributedTo:null);if(a){const r=new Ne(a,t,e);await Ae(r)}}},C=async()=>{if(o(l).size<10)try{let e=await z();e&&e>0&&await C()}catch(e){console.error(e)}},z=async()=>{let t=0;if(o(p)&&o(c)){te||(te=new(o(p)).EnigmatickCache);let n=await o(p).get_timeline(P,void 0,20,o(c),K());try{let a=JSON.parse(String(n));if(a.next){const r=Be(a.next);r.type==="max"&&r.value&&(P=r.value)}try{a.orderedItems&&a.orderedItems.length>0?(await Promise.all(a.orderedItems.map(r=>Q(r))),await w(),o(l).size>0&&(s(M,!0),s(x,!1))):o(l).size>0&&(await w(),s(M,!0),s(x,!1))}catch(r){console.error(r)}return length}catch(a){for(console.error(a);t++<10;)await ve(1e3),await z()}}else await ve(500),await z()};Fe(async e=>{if(e.to&&e.to.route.id===null){let t=e.to.url.href;const n=/^https:\/\/(?:[a-zA-Z0-9\-]+)(?:\.[a-zA-Z0-9\-]+)+?\/@[a-zA-Z0-9_]+$/,a=/^https:\/\/(?:[a-zA-Z0-9\-]+)(?:\.[a-zA-Z0-9\-]+)+?\/tags\/([a-zA-Z0-9\-_]+)$/,r=/^https:\/\/(?:[a-zA-Z0-9\-]+)(?:\.[a-zA-Z0-9\-]+)+?\/search\?tag=([a-zA-Z0-9\-_]+)$/;let h;if(t.match(n)){let u=Qe(t);u&&(e.cancel(),Je(`/${u}`))}else((h=t.match(a))||(h=t.match(r)))&&(ge.update(u=>{const m=new Set(u);return m.add(h[1].toLowerCase()),m}),e.cancel())}});const L=async()=>{let e=window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;return await w(),await w(),await w(),window.scrollTo({top:0,left:0,behavior:"instant"}),document.documentElement.scrollTop=0,document.body.scrollTop=0,e},q=async()=>{if(!S){S=!0;const n=document.body.scrollHeight||document.documentElement.scrollHeight,a=window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;let r=1;for(;a+window.innerHeight>=n*.9&&r>0;)r=await z()||0;S=!1}const e=document.getElementsByClassName("scroll")[0];(window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0)<50?e.style.display="none":e.style.display="flex"},G=async e=>{o(p)&&!I.has(e)&&I.set(e,o(p).get_note(e));const t=I.get(e);return t&&t instanceof Promise?await t:t},ze=async(e,t,n,a,r,h,u)=>{var m;if(o(p)){let d=(await o(p).NoteParams.new()).set_content(n);u||d.set_public(),d.set_attachments(JSON.stringify(a)),d.set_hashtags(h);for(const[i,D]of r)d.add_mention(i,D.id||"",((m=D.capabilities)==null?void 0:m.enigmatickEncryption)||!1);return t&&(d.set_in_reply_to(String(t.note.id)),d.set_conversation(String(t.note.conversation))),await o(p).send_note(d)}else return null},g=async()=>{s(l,new Map,!0),s(x,!0),s(M,!1),await L(),P=void 0;const e=document.getElementsByClassName("scroll")[0];e.style.display="none",await C()};let Z=f(!0);k(()=>{if(N()){s(Z,!1);return}{s(Z,!0);return}});let X=f(!1);k(()=>{if(!o(X))return;const e=Y().url.searchParams.get("view");e&&["home","local","direct","global"].includes(e)?o(c)!==e&&(s(c,e,!0),g()):Y().url.searchParams.has("view")||(o(H)&&o(c)!=="home"?(s(c,"home"),g()):!o(H)&&o(c)!=="global"&&(s(c,"global"),g()))});let R=f(null),ee=f(!0);k(()=>{const e=K(),t=Array.from(e).sort().join(",");if(o(ee)){(o(l).size>0||P!==void 0)&&(s(ee,!1),s(R,t,!0));return}o(R)!==t&&(s(R,t,!0),g())});let v=f(null);k(()=>{const e=o(H);o(v)===null&&e!==null?(s(v,e,!0),g()):o(v)!==e?(s(v,e,!0),g()):o(v)===null&&s(v,e,!0)});let te=null,l=f(ue(new Map)),Se=y(()=>(o(l).size,Array.from(o(l).values()))),S=!1,x=f(!0),M=f(!1),P,I=new Map,H=y(()=>Te().username),oe=0,_=ue([]);const ae=()=>{S||(oe=window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0)};var ne=Xe(),se=J(ne);{let e=y(()=>o(c)==="direct");he(Ze(se,{senderFunction:ze,onPublish:t=>Q(t.activity),get direct(){return o(e)},cachedNoteFunction:G}),t=>s($,t,!0),()=>o($))}var re=O(se,2);Ge(re,{});var le=O(re,2),W=U(le);let ie;var ce=U(W),F=U(ce);F.__click=L,F.__keydown=e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),L())};var de=O(F,2);{var xe=e=>{var t=me(),n=J(t);pe(n,16,()=>Array(3),we,(a,r)=>{We(a)}),V(e,t)};fe(de,e=>{o(x)&&!o(M)&&e(xe)})}var Me=O(de,2);pe(Me,17,()=>o(Se),we,(e,t,n)=>{var a=me(),r=J(a);{var h=u=>{{let m=y(()=>{var i;return(i=o($))==null?void 0:i.handleReplyToMessage}),d=y(()=>{var i;return(i=o($))==null?void 0:i.handleEditNote});he(Re(u,{get parentArticle(){return _[n]},get note(){return o(t)},get onReplyTo(){return o(m)},get onEdit(){return o(d)},cachedNote:G}),(i,D)=>_[D]=i,i=>_==null?void 0:_[i],()=>[n])}};fe(r,u=>{var m,d,i;(m=o(t))!=null&&m.note&&(!o(t).note.inReplyTo||(i=(d=o(t).note.ephemeral)==null?void 0:d.announces)!=null&&i.length)&&u(h)})}V(e,a)}),B(ce),B(W),B(le),Ye(()=>ie=Ce(W,1,"content svelte-1fjec68",null,ie,{"filters-hidden":!o(Z)&&!N()})),V(ye,ne),je(),$e()}Pe(["click","keydown"]);export{wt as component};
