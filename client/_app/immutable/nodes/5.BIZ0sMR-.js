import"../chunks/CWj6FrbW.js";import"../chunks/CGsJVIYN.js";import{p as le,o as ce,l as X,j as de,k as $,aB as fe,m as P,n as j,a as pe,q as v,aC as k,v as e,t as I,r as T,i as ge,z as b,u as g,ay as A,D as _e,aA as O,aD as me,aE as ve}from"../chunks/C-PNKZ_s.js";import{i as ue}from"../chunks/CPpPu6cz.js";import{e as U,i as J}from"../chunks/gGHH_MYY.js";import{g as Z,s as M}from"../chunks/CT8Pszs0.js";import{p as L}from"../chunks/CWmzcjye.js";import{i as Se}from"../chunks/DWt-1M3a.js";import{s as ye,a as ke}from"../chunks/ChSDbmkr.js";import"../chunks/DBPuqUlq.js";import{a as q,e as we}from"../chunks/n0qzx-_D.js";var he=$('<li class="svelte-1kh7jkw"><div class="svelte-1kh7jkw"><img alt="Profile" class="svelte-1kh7jkw"/></div> <div class="svelte-1kh7jkw"><span class="svelte-1kh7jkw"> </span> <span class="svelte-1kh7jkw"> </span></div></li>'),Ee=$('<li class="svelte-1kh7jkw"><div class="svelte-1kh7jkw"><img alt="Profile"/></div> <div class="svelte-1kh7jkw"><span class="svelte-1kh7jkw"> </span> <span class="svelte-1kh7jkw"> </span></div></li>'),be=$('<form id="message" method="POST"><label>Message <textarea name="message"></textarea></label> <button>Send Message</button></form>'),Ne=$('<li class="svelte-1kh7jkw"><span> </span> <span> </span> <span> </span></li>'),Te=$('<div class="contacts svelte-1kh7jkw"><ul class="svelte-1kh7jkw"></ul></div> <main class="svelte-1kh7jkw"><button>Process Queue</button> <ul class="svelte-1kh7jkw"></ul> <!> <ul class="svelte-1kh7jkw"></ul></main>',1);function Me(ee,se){le(se,!1);const R=()=>ke(we,"$enigmatickWasm",te),[te,ne]=ye(),t=I(),C=I();let h;ce(async()=>{console.debug(e(t)),console.debug(e(C)),e(t)&&e(C)&&(e(t)&&(h=e(t).get_state().get_olm_pickled_account(),e(t).get_followers().then(s=>{s&&(JSON.parse(s).forEach(a=>{a.id&&e(y).set(a.id,a)}),console.debug(e(y)),T(y,e(y)))}),e(t).get_following().then(s=>{s&&(JSON.parse(s).forEach(a=>{a.id&&e(y).set(a.id,a)}),console.debug(e(y)),T(y,e(y)))})),e(t).get_sessions().then(async c=>{var o;const s=JSON.parse(String(c));console.info("SESSIONS"),console.debug(s),(o=s.items)==null||o.forEach(async a=>{var n,_;if(typeof a.to=="string"){let u=await((n=e(t))==null?void 0:n.get_actor(a.to));const i=JSON.parse(String(u));let d;i.icon&&i.icon.type==="Image"&&(d=i.icon.url);let r,l;const p=a.instrument;p.content?p.type==="OlmSession"&&(l=p.uuid):Array.isArray(a.instrument)&&a.instrument.forEach(m=>{m.type==="OlmSession"&&(l=m.uuid)});const f=String(a.to);e(w).set(f,[f,await((_=e(t))==null?void 0:_.get_webfinger_from_id(f)),i.name,d,l,r]),T(w,e(w))}}),console.info(e(w))}),K())});function K(){var c;(c=e(t))==null||c.get_processing_queue().then(async s=>{var a;console.info("QUEUE"),console.debug(s);const o=JSON.parse(String(s));console.log(o),(a=o.items)==null||a.forEach(async n=>{var _,u;if(n.type==="EncryptedSession"){console.info("ENCRYPTED SESSION");let i=null,d=null;if(n.instrument&&n.instrument.forEach){n.instrument.forEach(f=>{console.info(`TYPE ${f.type}, CONTENT ${f.content}`),f.type==="IdentityKey"?i=f.content:f.type==="SessionKey"&&(d=f.content)});const r=n.attributedTo,l=JSON.parse(String(await((_=e(t))==null?void 0:_.get_actor(r))));let p;if(l.icon&&l.icon.type==="Image"&&(p=l.icon.url),i&&d){let f=(u=e(t))==null?void 0:u.create_olm_message(r,"SESSION_INIT",String(h),i,d);if(f){console.info("SESSION INIT"),console.info(f.message),console.info(f.session);const m=f.session;if(e(t)){let S=(await(await e(t).SendParams.new()).add_recipient_id(r,!1)).set_encrypted().set_identity_key(e(t).get_identity_public_key(String(h))).set_session_data(m).set_content(f.message);e(t).send_encrypted_note(S).then(async()=>{var G,H;const N=`${n.id}#processing`;(G=e(t))==null||G.resolve_processed_item(N).then(()=>{console.info(`QUEUE ITEM RESOLVED: ${N}`)}),e(w).set(r,[r,await((H=e(t))==null?void 0:H.get_webfinger_from_id(r)),l.name,p,void 0,m]),console.info("SESSION INIT SENT")})}}}}}else if(n.type==="EncryptedNote"&&(console.info("ENCRYPTED NOTE"),n.tag)){let i=null;if(n.tag.forEach(d=>{const r=d;r.type==="Mention"&&r.name===n.attributedTo&&r.value&&(i=r.value)}),e(t)&&i){let d,r;const l=n.attributedTo,p=JSON.parse(String(await e(t).get_actor(l)));let f;if(p.icon&&p.icon.type==="Image"&&(f=p.icon.url),n.instrument&&n.instrument.type=="OlmSession"){const S=n.instrument;console.warn(S),r=S.uuid}const m=e(t).decrypt_olm_message(n.attributedTo,n.content,String(h),String(i),d);if(m)if(console.info(`MESSAGE: ${m.message}`),m.message==="SESSION_INIT"){const S=e(t).create_olm_message(n.attributedTo,"SESSION_ACK",String(h),i,void 0,m.session);if(S){const N=(await(await e(t).SendParams.new()).add_recipient_id(n.attributedTo,!1)).set_encrypted().set_identity_key(e(t).get_identity_public_key(String(h))).set_session_data(S.session).set_session_uuid(r).set_content(S.message).resolves(`${n.id}#processing`);e(t).send_encrypted_note(N).then(()=>{console.info("SESSION ACK SENT")})}}else{const S=JSON.stringify({message:m.message,published:n.published});e(t).store_to_vault(S,n.attributedTo,`${n.id}#processing`,String(r),m.session,String(e(t).get_hash(new TextEncoder().encode(String(d))))).then(async()=>{var N;e(w).set(l,[l,await((N=e(t))==null?void 0:N.get_webfinger_from_id(l)),p.name,f,r,m.session]),console.info("STORED TO VAULT")})}}}})})}async function ae(c){let s=new FormData(c.target);const o=s.get("message");if(console.log(s),e(E)){const a=e(w).get(e(E));if(e(t)&&a){const[n,_,u,i,d,r]=a;if(r){const l=e(t).create_olm_message(e(E),String(o),String(h),void 0,void 0,r);if(console.debug(l),l){console.info("ENCRYPTED"),console.debug(l.message);const p=(await(await e(t).SendParams.new()).add_recipient_id(e(E),!1)).set_encrypted().set_identity_key(e(t).get_identity_public_key(String(h))).set_session_data(l.session).set_session_uuid(d).set_content(l.message);e(t).send_encrypted_note(p).then(()=>{console.log("NOTE SENT")})}}}}}async function oe(c){var o,a;T(E,c.target.dataset.recipient);let s=await((o=e(t))==null?void 0:o.get_vault(0,40,String(e(E))));if(console.log(`SELECTED: ${e(E)}`),console.log(`VAULT: ${s}`),T(Q,[]),s){let n=JSON.parse(s);console.info(n),(a=n.orderedItems)==null||a.forEach(_=>{})}}function ie(c,s){return c.preferredUsername.toLowerCase()<s.preferredUsername.toLowerCase()?-1:c.preferredUsername.toLowerCase()>s.preferredUsername.toLowerCase()?1:0}let w=I(new Map),E=I(null),Q=I([]),y=I(new Map);X(()=>R(),()=>{T(t,R())}),X(()=>q,()=>{T(C,ge(q).username)}),de(),Se();var W=Te(),x=fe(W),Y=v(x);U(Y,5,()=>(e(y),b(()=>Array.from(e(y).values()).sort(ie))),J,(c,s)=>{var o=he(),a=v(o),n=v(a);g(a);var _=k(a,2),u=v(_),i=v(u,!0);g(u);var d=k(u,2),r=v(d,!0);g(d),g(_),g(o),A(l=>{M(n,"src",(e(s),b(()=>{var p;return(p=e(s).icon)==null?void 0:p.url}))),O(i,(e(s),b(()=>e(s).name))),O(r,l)},[()=>(_e(Z),e(s),b(()=>Z(e(s))))]),j(c,o)}),g(Y),g(x);var F=k(x,2),V=v(F),D=k(V,2);U(D,5,()=>(e(w),b(()=>Array.from(e(w).values()))),J,(c,s)=>{var o=me(()=>ve(e(s),6));let a=()=>e(o)[0],n=()=>e(o)[1],_=()=>e(o)[2],u=()=>e(o)[3];var i=Ee(),d=v(i),r=v(d);g(d);var l=k(d,2),p=v(l),f=v(p,!0);g(p);var m=k(p,2),S=v(m,!0);g(m),g(l),g(i),A(()=>{M(i,"data-recipient",a()),M(r,"src",u()),O(f,_()),O(S,n())}),P("click",i,L(oe)),j(c,i)}),g(D);var z=k(D,2);{var re=c=>{var s=be();P("submit",s,L(ae)),j(c,s)};ue(z,c=>{e(E)&&c(re)})}var B=k(z,2);U(B,5,()=>e(Q),J,(c,s)=>{var o=Ne(),a=v(o),n=v(a,!0);g(a);var _=k(a,2),u=v(_,!0);g(_);var i=k(_,2),d=v(i,!0);g(i),g(o),A(()=>{O(n,(e(s),b(()=>e(s).attributedTo))),O(u,(e(s),b(()=>e(s).published))),O(d,(e(s),b(()=>e(s).message)))}),j(c,o)}),g(B),g(F),P("click",V,L(K)),j(ee,W),pe(),ne()}export{Me as component};
