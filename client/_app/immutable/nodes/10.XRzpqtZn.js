import{s as ce,f as v,a as E,g as y,h as F,c as M,u as x,d as T,j as L,i as H,v as s,D as q,E as G,G as ee,I as ue,M as re,x as V,o as fe,l as K,m as j,F as de,k as _e,n as J,p as pe}from"../chunks/scheduler.tnyNm5U0.js";import{e as te}from"../chunks/each.-oqiv04n.js";import{S as ge,i as he}from"../chunks/index.R_ElRwcJ.js";import{a as Z,w as z}from"../chunks/stores.bABpd-zC.js";import me,{load_instance_information as ve,authenticate as ye,get_state as Q,get_processing_queue as be,create_olm_message as ne,SendParams as Se,send_encrypted_note as ke,upload_avatar as Te,get_hash as $,get_one_time_keys as Ce,OtkUpdateParams as we,add_one_time_keys as Ee,import_state as Me}from"../chunks/@vite-plugin-wasm-pack@enigmatick_wasm.RuluYclm.js";function le(r,t,i){const f=r.slice();return f[17]=t[i],f}function oe(r){let t,i="OTK",f,h,k,a,w,O,S,m,_,p,R,A,N="Choose Image",D,C,B,U;return{c(){t=v("button"),t.textContent=i,f=E(),h=v("div"),k=K("Logged in as: "),a=v("a"),w=K(r[0]),S=E(),m=v("div"),_=v("img"),R=E(),A=v("div"),A.textContent=N,D=E(),C=v("input"),this.h()},l(l){t=y(l,"BUTTON",{"data-svelte-h":!0}),x(t)!=="svelte-1le57p3"&&(t.textContent=i),f=M(l),h=y(l,"DIV",{});var u=F(h);k=j(u,"Logged in as: "),a=y(u,"A",{href:!0});var b=F(a);w=j(b,r[0]),b.forEach(T),u.forEach(T),S=M(l),m=y(l,"DIV",{});var e=F(m);_=y(e,"IMG",{class:!0,src:!0,alt:!0}),R=M(e),A=y(e,"DIV",{class:!0,"data-svelte-h":!0}),x(A)!=="svelte-c5ssl8"&&(A.textContent=N),D=M(e),C=y(e,"INPUT",{style:!0,type:!0,accept:!0}),e.forEach(T),this.h()},h(){L(a,"href",O="/@"+r[0]),L(_,"class","upload"),de(_.src,p="https://static.thenounproject.com/png/625182-200.png")||L(_,"src",p),L(_,"alt",""),L(A,"class","chan"),_e(C,"display","none"),L(C,"type","file"),L(C,"accept",".jpg, .jpeg, .png")},m(l,u){H(l,t,u),H(l,f,u),H(l,h,u),s(h,k),s(h,a),s(a,w),H(l,S,u),H(l,m,u),s(m,_),s(m,R),s(m,A),s(m,D),s(m,C),r[11](C),B||(U=[q(t,"click",r[7]),q(_,"click",r[8]),q(A,"click",r[9]),q(C,"change",r[10])],B=!0)},p(l,u){u&1&&J(w,l[0]),u&1&&O!==(O="/@"+l[0])&&L(a,"href",O)},d(l){l&&(T(t),T(f),T(h),T(S),T(m)),r[11](null),B=!1,re(U)}}}function se(r){let t,i,f=r[17].plaintext+"",h,k,a,w='<textarea name="content"></textarea> <button>Send</button>',O,S;function m(){return r[12](r[17])}return{c(){t=v("span"),i=K("Message: "),h=K(f),k=E(),a=v("form"),a.innerHTML=w,this.h()},l(_){t=y(_,"SPAN",{});var p=F(t);i=j(p,"Message: "),h=j(p,f),p.forEach(T),k=M(_),a=y(_,"FORM",{id:!0,method:!0,"data-svelte-h":!0}),x(a)!=="svelte-zcfgqh"&&(a.innerHTML=w),this.h()},h(){L(a,"id","respond"),L(a,"method","POST")},m(_,p){H(_,t,p),s(t,i),s(t,h),H(_,k,p),H(_,a,p),O||(S=q(a,"submit",G(m)),O=!0)},p(_,p){r=_,p&2&&f!==(f=r[17].plaintext+"")&&J(h,f)},d(_){_&&(T(t),T(k),T(a)),O=!1,S()}}}function ae(r){let t,i='<textarea name="content"></textarea> <button>Send</button>',f,h;function k(){return r[13](r[17])}return{c(){t=v("form"),t.innerHTML=i,this.h()},l(a){t=y(a,"FORM",{id:!0,method:!0,"data-svelte-h":!0}),x(t)!=="svelte-1rgrcb"&&(t.innerHTML=i),this.h()},h(){L(t,"id","message"),L(t,"method","POST")},m(a,w){H(a,t,w),f||(h=q(t,"submit",G(k)),f=!0)},p(a,w){r=a},d(a){a&&T(t),f=!1,h()}}}function ie(r){let t,i,f,h,k=r[17].recipient+"",a,w,O,S,m,_,p=r[17].sender+"",R,A,N,D,C,B,U=r[17].type+"",l,u,b,e,g,d,o=r[17].plaintext&&se(r),n=r[17].session_key&&r[17].identity_key&&ae(r);return{c(){t=v("li"),i=v("div"),f=v("span"),h=K("Recipient: "),a=K(k),w=E(),O=v("br"),S=E(),m=v("span"),_=K("Sender: "),R=K(p),A=E(),N=v("br"),D=E(),C=v("span"),B=K("Type: "),l=K(U),u=E(),b=v("br"),e=E(),o&&o.c(),g=E(),n&&n.c(),d=E()},l(c){t=y(c,"LI",{});var I=F(t);i=y(I,"DIV",{});var P=F(i);f=y(P,"SPAN",{});var W=F(f);h=j(W,"Recipient: "),a=j(W,k),W.forEach(T),w=M(P),O=y(P,"BR",{}),S=M(P),m=y(P,"SPAN",{});var Y=F(m);_=j(Y,"Sender: "),R=j(Y,p),Y.forEach(T),A=M(P),N=y(P,"BR",{}),D=M(P),C=y(P,"SPAN",{});var X=F(C);B=j(X,"Type: "),l=j(X,U),X.forEach(T),u=M(P),b=y(P,"BR",{}),e=M(P),o&&o.l(P),g=M(P),n&&n.l(P),P.forEach(T),d=M(I),I.forEach(T)},m(c,I){H(c,t,I),s(t,i),s(i,f),s(f,h),s(f,a),s(i,w),s(i,O),s(i,S),s(i,m),s(m,_),s(m,R),s(i,A),s(i,N),s(i,D),s(i,C),s(C,B),s(C,l),s(i,u),s(i,b),s(i,e),o&&o.m(i,null),s(i,g),n&&n.m(i,null),s(t,d)},p(c,I){I&2&&k!==(k=c[17].recipient+"")&&J(a,k),I&2&&p!==(p=c[17].sender+"")&&J(R,p),I&2&&U!==(U=c[17].type+"")&&J(l,U),c[17].plaintext?o?o.p(c,I):(o=se(c),o.c(),o.m(i,g)):o&&(o.d(1),o=null),c[17].session_key&&c[17].identity_key?n?n.p(c,I):(n=ae(c),n.c(),n.m(i,null)):n&&(n.d(1),n=null)},d(c){c&&T(t),o&&o.d(),n&&n.d()}}}function Oe(r){let t,i,f,h=`<label>Username
			<input name="username" type="text"/></label> <label>Password
			<input name="password" type="password"/></label> <button>Authenticate</button>`,k,a,w="Message",O,S,m="Profile",_,p,R="Inbox",A,N,D="Queue",C,B,U,l,u,b,e=r[0]&&oe(r),g=te(r[1]),d=[];for(let o=0;o<g.length;o+=1)d[o]=ie(le(r,g,o));return{c(){t=v("main"),e&&e.c(),i=E(),f=v("form"),f.innerHTML=h,k=E(),a=v("a"),a.textContent=w,O=E(),S=v("a"),S.textContent=m,_=E(),p=v("button"),p.textContent=R,A=E(),N=v("button"),N.textContent=D,C=E(),B=v("br"),U=E(),l=v("ul");for(let o=0;o<d.length;o+=1)d[o].c();this.h()},l(o){t=y(o,"MAIN",{});var n=F(t);e&&e.l(n),i=M(n),f=y(n,"FORM",{id:!0,method:!0,"data-svelte-h":!0}),x(f)!=="svelte-lzco3s"&&(f.innerHTML=h),k=M(n),a=y(n,"A",{href:!0,"data-svelte-h":!0}),x(a)!=="svelte-ry419"&&(a.textContent=w),O=M(n),S=y(n,"A",{href:!0,"data-svelte-h":!0}),x(S)!=="svelte-1okgglh"&&(S.textContent=m),_=M(n),p=y(n,"BUTTON",{"data-svelte-h":!0}),x(p)!=="svelte-1g0ycm7"&&(p.textContent=R),A=M(n),N=y(n,"BUTTON",{"data-svelte-h":!0}),x(N)!=="svelte-1fxu91l"&&(N.textContent=D),C=M(n),B=y(n,"BR",{}),U=M(n),l=y(n,"UL",{});var c=F(l);for(let I=0;I<d.length;I+=1)d[I].l(c);c.forEach(T),n.forEach(T),this.h()},h(){L(f,"id","login"),L(f,"method","POST"),L(a,"href","/message"),L(S,"href","/profile")},m(o,n){H(o,t,n),e&&e.m(t,null),s(t,i),s(t,f),s(t,k),s(t,a),s(t,O),s(t,S),s(t,_),s(t,p),s(t,A),s(t,N),s(t,C),s(t,B),s(t,U),s(t,l);for(let c=0;c<d.length;c+=1)d[c]&&d[c].m(l,null);u||(b=[q(f,"submit",G(r[3])),q(p,"click",G(Ae)),q(N,"click",G(r[4]))],u=!0)},p(o,[n]){if(o[0]?e?e.p(o,n):(e=oe(o),e.c(),e.m(t,i)):e&&(e.d(1),e=null),n&34){g=te(o[1]);let c;for(c=0;c<g.length;c+=1){const I=le(o,g,c);d[c]?d[c].p(I,n):(d[c]=ie(I),d[c].c(),d[c].m(l,null))}for(;c<d.length;c+=1)d[c].d(1);d.length=g.length}},i:ee,o:ee,d(o){o&&T(t),e&&e.d(),ue(d,o),u=!1,re(b)}}}function Ae(r){}function Ie(r,t,i){function f(){me().then(()=>{ve().then(l=>{console.log(l?.domain),console.log(l?.url),V(z)&&(Me(V(z)),console.log("loaded state from store")),console.log("init WASM")})})}let h=V(Z).username;fe(()=>{f()});function k(l){let u=new FormData(l.target);ye(String(u.get("username")),String(u.get("password"))).then(b=>{Z.set({username:String(b?.username),display_name:String(b?.display_name),avatar:String(b?.avatar_filename),domain:null,url:null}),i(0,h=V(Z).username);let e=Q();if(console.log(e),z.set(e.export()),JSON.stringify({pickled_account:e.get_olm_pickled_account(),olm_sessions:JSON.parse(e.get_olm_sessions())}),console.log(V(z)),h){const g=new EventSource("/api/user/"+h+"/events");g.onmessage=d=>{console.log("event: "+d.data)}}})}let a=[];function w(l){a.push(l),i(1,a)}async function O(l){console.log(l),be().then(async u=>{console.log(u);let b=JSON.parse(String(u));console.log(b),b.items.forEach(async e=>{let g=null,d=null;e.instrument instanceof Object&&(e.instrument.type=="IdentityKey"?g=e.instrument.content:e.instrument.type=="SessionKey"&&(d=e.instrument.content)),e.instrument instanceof Array&&e.instrument.forEach(n=>{n.type=="IdentityKey"?g=n.content:n.type=="SessionKey"&&(d=n.content)});let o="";if(typeof e.to=="object"&&(o=e.to[0]),typeof e.to=="string"&&(o=e.to),g&&d){let n={recipient:o,sender:e.attributedTo,type:e.type,reference:e.reference,identity_key:g,session_key:d};w(n)}if(e.content){let n="";e.type==="EncryptedNote"&&Q().get_olm_pickled_account;let c={recipient:o,sender:e.attributedTo,type:e.type,content:e.content,plaintext:n};w(c)}})})}async function S(l,u,b,e){let g=new FormData(l.target);console.log(l),console.log(u),console.log(b),console.log(e),console.log(g.get("content"));let d="",o=Q().get_olm_pickled_account;b&&e?d=String(ne(u,String(g.get("content")),String(o),b,e)):d=String(ne(u,String(g.get("content")),String(o)));let n=await Se.new();n=await n.add_recipient_id(u,!1),n=n.set_content(String(d)),n=n.set_encrypted(),ke(n).then(()=>{console.log("note sent")})}let m,_;const p=l=>{console.log("type :"+l.type);let u=l.target;if(u.files!==null){let b=u.files[0],e=new FileReader;e.readAsArrayBuffer(b),e.onload=g=>{if(g.target!==null){m=g.target.result!==null?g.target.result:null,console.log(m);let d=new Uint8Array(m);console.log("ba: "+d),Te(d,m.byteLength,"")}}}};async function R(l){const u=Q().get_olm_pickled_account();console.info("PRE-MUTATION"),console.log(u);let b=$(new TextEncoder().encode(String(u)));console.info("HASH"),console.log(b);let e=Ce(String(u));console.info("KEYS"),console.log(e.one_time_keys),console.info("PICKLED ACCOUNT"),console.log(e.pickled_account),console.info("POST-MUTATION"),console.log($(new TextEncoder().encode(e.pickled_account)));let g=we.new().set_account(e.pickled_account).set_account_hash(String($(new TextEncoder().encode(e.pickled_account)))).set_mutation(String(b)).set_keys(e.one_time_keys);Ee(g)}const A=()=>{_.click()},N=()=>{_.click()},D=l=>p(l);function C(l){pe[l?"unshift":"push"](()=>{_=l,i(2,_)})}return[h,a,_,k,O,S,p,R,A,N,D,C,l=>S(window.event,String(l.sender)),l=>S(window.event,String(l.sender),String(l.identity_key),String(l.session_key))]}class De extends ge{constructor(t){super(),he(this,t,Ie,Oe,ce,{})}}export{De as component};
