import"../chunks/CWj6FrbW.js";import{aH as _e,aE as ye,p as je,j as $,k as Se,m as L,n as xe,q as b,ad as h,v as a,ah as W,u as g,af as ke,ag as Oe,o as Ve,aI as C,G as be,ae,r as m,aJ as A,aF as Ge}from"../chunks/iAwc3qQu.js";import{i as se}from"../chunks/BeCdKdsH.js";import{e as Ae,i as Te,s as we,b as qe,d as Qe,D as Ue,f as Ke}from"../chunks/y_H1LLdF.js";import{C as Xe,s as Ye,A as et}from"../chunks/ZP8CHS7V.js";import{b as R}from"../chunks/CsyQ7Zbw.js";import{a as le,s as tt}from"../chunks/CTRaWkmf.js";import{b as at,g as st}from"../chunks/BZzrGudY.js";import{a as lt,e as nt}from"../chunks/BjbtEI9d.js";import"../chunks/BfK2I2Fg.js";import{s as ot}from"../chunks/e-kiUM3O.js";import"../chunks/D2xv9s3J.js";const rt=T=>typeof window>"u"||!T?_e(!1):_e(!1,p=>{const S=window.matchMedia(T);p(S.matches);const D=x=>p(x.matches);return S.addEventListener("change",D),()=>{S.removeEventListener("change",D)}});var it=$('<a href="#filters" title="Delete" class="svelte-1avybgx"> </a>'),ct=$('<div class="filters svelte-1avybgx"><div class="svelte-1avybgx"></div> <form class="svelte-1avybgx"><input type="text" name="statement" placeholder="Filter Statement (e.g., #Enigmatick)" class="svelte-1avybgx"/></form></div>');function ft(T,v){je(v,!0);let p,S=W(()=>{const n=v.hashtags;return n.size,Array.from(n)});const D=n=>{var E;n.preventDefault();const f=new FormData(p);let o;if(o=(E=f.get("statement"))==null?void 0:E.toString().trim()){o=o.startsWith("#")?o.slice(1):o;const H=o.toString().toLowerCase();v.onHashtagAdd?v.onHashtagAdd(H):v.hashtags.add(H),v.resetData()}p.reset()},x=n=>{n.preventDefault();let f=n.currentTarget||n.target,o=f==null?void 0:f.dataset.tag;o&&(v.onHashtagRemove?v.onHashtagRemove(o):v.hashtags.delete(o),v.resetData())};var Z=ct(),w=b(Z);Ae(w,21,()=>a(S),Te,(n,f)=>{var o=it();o.__click=x;var E=b(o);g(o),ke(()=>{ot(o,"data-tag",a(f)),Oe(E,`#${a(f)??""}`)}),L(n,o)}),g(w);var _=h(w,2);R(_,n=>p=n,()=>p),g(Z),Se("submit",_,D),L(T,Z),xe()}ye(["click"]);var dt=$('<button class="selected svelte-1fjec68" data-view="home" aria-label="Home view"><i class="fa-solid fa-house svelte-1fjec68"></i></button> <button data-view="local" aria-label="Local view" class="svelte-1fjec68"><i class="fa-solid fa-hotel svelte-1fjec68"></i></button> <button data-view="direct" aria-label="Direct messages view" class="svelte-1fjec68"><i class="fa-solid fa-at svelte-1fjec68"></i></button>',1),vt=$('<div class="back svelte-1fjec68" role="button" tabindex="0"><i class="fa-solid fa-angles-left"></i></div>'),mt=$('<!> <main class="svelte-1fjec68"><div class="content svelte-1fjec68"><header class="svelte-1fjec68"><nav class="svelte-1fjec68"><!> <button data-view="global" aria-label="Global view" class="svelte-1fjec68"><i class="fa-solid fa-globe svelte-1fjec68"></i></button></nav>  <div class="scroll svelte-1fjec68" role="button" tabindex="0"><i class="fa-solid fa-chevron-up svelte-1fjec68"></i></div></header> <div class="scrollable svelte-1fjec68"></div> <!></div> <div class="context svelte-1fjec68"><div class="svelte-1fjec68"><h1 class="svelte-1fjec68">Filters</h1> <!></div> <div class="handle svelte-1fjec68"><a href="#filters" aria-label="Toggle filters" class="svelte-1fjec68">&nbsp</a></div></div></main>',1);function At(T,v){je(v,!0);const p=()=>le(nt,"$enigmatickWasm",x),S=()=>le(lt,"$appData",x),D=()=>le(o,"$isSmallScreen",x),[x,Z]=tt();let w=C(void 0),_=C(""),n=W(p),f;const o=rt("(max-width: 1000px)");Ve(async()=>{d&&d.addEventListener("scroll",Ee),re?m(_,"home"):m(_,"global"),await O()});const E=async e=>{if(console.debug(`Placing ${e.note.id}`),!e.note.inReplyTo&&e.note.id){a(u).has(e.note.id)||m(u,new Map(a(u)).set(e.note.id,e),!0),await H(!0,0);return}const t=s=>{for(const[,l]of s.entries()){if(l.note.id===e.note.inReplyTo&&e.note.id)return l.replies.has(e.note.id)||l.replies.set(e.note.id,e),!0;if(t(l.replies))return!0}return!1};if(e.note.inReplyTo&&t(a(u))){m(u,new Map(a(u)),!0),await H(!1);return}await H(!1)},H=async(e,t)=>{try{let s=fe;if(m(u,a(u),!0),e&&t){for(let l=0;l<t;l++)await A();d.scrollTo({top:s,left:0,behavior:"instant"})}}catch(s){console.error(s)}},ne=async e=>{var t,s;if(console.debug(`Adding ${e.object.id}`),console.debug(e.object),e.object.attributedTo){console.debug(`Attributed to ${(t=e.object.ephemeral)==null?void 0:t.attributedTo}`);const l=Qe((s=e.object.ephemeral)==null?void 0:s.attributedTo);if(l){const i=new Ue(l,e.object,e);await E(i)}}},O=async()=>{let e=0;if(a(u).forEach(t=>{t.note.inReplyTo||(e+=1)}),e<10)try{let t=await I();t&&t>0&&await O()}catch(t){console.error(t)}},I=async()=>{var s;let t=0;if(a(n)&&a(_)&&d){oe||(oe=new(a(n)).EnigmatickCache);let l=await a(n).get_timeline(U,void 0,20,a(_),a(y));try{let i=JSON.parse(String(l));if(i.next){const c=Ke(i.next);c.type==="max"&&c.value&&(U=c.value)}try{(s=i.orderedItems)==null||s.forEach(c=>{ne(c)})}catch(c){console.error(c)}return length}catch(i){for(console.error(i);t++<10;)await we(1e3),await I()}}else await we(500),await I()};at(async e=>{if(e.to&&e.to.route.id===null){let t=e.to.url.href;const s=/^https:\/\/(?:[a-zA-Z0-9\-]+)(?:\.[a-zA-Z0-9\-]+)+?\/@[a-zA-Z0-9_]+$/,l=/^https:\/\/(?:[a-zA-Z0-9\-]+)(?:\.[a-zA-Z0-9\-]+)+?\/tags\/([a-zA-Z0-9\-_]+)$/,i=/^https:\/\/(?:[a-zA-Z0-9\-]+)(?:\.[a-zA-Z0-9\-]+)+?\/search\?tag=([a-zA-Z0-9\-_]+)$/;let c;if(t.match(s)){let j=qe(t);j&&(e.cancel(),st(`/${j}`))}else((c=t.match(l))||(c=t.match(i)))&&(m(y,new Set(a(y)).add(c[1].toLowerCase()),!0),e.cancel(),q())}});const J=async e=>{if(e.target){let t=e.target.dataset.view;t&&(Array.from(document.getElementsByTagName("header")[0].getElementsByTagName("nav")[0].getElementsByTagName("button")).forEach(s=>s.classList.remove("selected")),e.target.classList.add("selected"),m(_,t,!0),await q())}},V=async()=>{var e;m(ie,null),m(M,null),(e=a(w))==null||e.resetCompose(),await De(),Q=!1},De=async()=>{await A(),await A(),await A(),d.scrollTo({top:Fe,left:0,behavior:"instant"})},G=async()=>{let e=d.scrollTop;return await A(),await A(),await A(),d.scrollTo({top:0,left:0,behavior:"instant"}),e},Ee=async()=>{if(!N&&!Q&&!a(M)){N=!0;let t=1;for(;!Q&&d.scrollTop+d.offsetHeight>=d.scrollHeight*.9&&t>0;)t=await I()||0;N=!1}const e=document.getElementsByClassName("scroll")[0];d.scrollTop<50?e.style.display="none":e.style.display="revert"},He=async e=>{a(n)&&!K.has(e)&&K.set(e,a(n).get_note(e));const t=K.get(e);return t&&t instanceof Promise?await t:t},Me=async(e,t,s,l,i,c,j)=>{var k;if(a(n)){let r=(await a(n).SendParams.new()).set_content(s);j||r.set_public(),r.set_attachments(JSON.stringify(l)),r.set_hashtags(c);for(const[z,pe]of i)r.add_mention(z,pe.id||"",((k=pe.capabilities)==null?void 0:k.enigmatickEncryption)||!1);return t&&(r.set_in_reply_to(String(t.note.id)),r.set_conversation(String(t.note.conversation))),await a(n).send_note(r)}else return null},ze=()=>{},Ce=e=>{const t=new Set(a(y));t.add(e),m(y,t,!0)},Re=e=>{const t=new Set(a(y));t.delete(e),m(y,t,!0)},q=async()=>{V(),m(u,new Map,!0),await G(),U=void 0;const e=document.getElementsByClassName("scroll")[0];e.style.display="none",await O()},Le=e=>{e&&e.preventDefault(),f.style.display==="none"?f.style.display="flex":f.style.display="none"};let oe=null,y=C(be(new Set)),Q=!1,u=C(be(new Map)),Ze=W(()=>(a(u).size,Array.from(a(u).values()))),N=!1,U,K=new Map,re=S().username,M=C(null),ie=C(null),Fe=0,ce,d,fe=0,F=[];const Pe=e=>{!N&&!a(M)&&(fe=d.scrollTop)};var de=mt(),ve=ae(de);{let e=W(()=>a(_)==="direct");R(Xe(ve,{senderFunction:Me,onPublish:t=>ne(t.activity),get direct(){return a(e)}}),t=>m(w,t,!0),()=>a(w))}var me=h(ve,2),X=b(me),Y=b(X),ee=b(Y),ue=b(ee);{var Be=e=>{var t=dt(),s=ae(t);s.__click=J;var l=h(s,2);l.__click=J;var i=h(l,2);i.__click=J,L(e,t)};se(ue,e=>{re&&e(Be)})}var We=h(ue,2);We.__click=J,g(ee);var he=h(ee,2);he.__click=G,he.__keydown=e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),G())},g(Y);var P=h(Y,2);Ae(P,21,()=>a(Ze),Te,(e,t,s)=>{var l=Ge(),i=ae(l);{var c=j=>{{let k=W(()=>{var r;return(r=a(w))==null?void 0:r.handleReplyToMessage});R(et(j,{get parentArticle(){return F[s]},remove:ze,get note(){return a(t)},get onReplyTo(){return a(k)},cachedNote:He}),(r,z)=>F[z]=r,r=>F==null?void 0:F[r],()=>[s])}};se(i,j=>{var k,r,z;(k=a(t))!=null&&k.note&&(!a(M)&&(!a(t).note.inReplyTo||(z=(r=a(t).note.ephemeral)==null?void 0:r.announces)!=null&&z.length)||a(t).note.id==a(M))&&j(c)})}L(e,l)}),g(P),R(P,e=>d=e,()=>d);var $e=h(P,2);{var Ie=e=>{var t=vt();t.__click=s=>{s.preventDefault(),V()},t.__keydown=s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),V())},L(e,t)};se($e,e=>{(a(M)||a(ie))&&e(Ie)})}g(X);var ge=h(X,2),B=b(ge),Je=h(b(B),2);ft(Je,{get hashtags(){return a(y)},resetData:q,onHashtagAdd:Ce,onHashtagRemove:Re}),g(B),R(B,e=>f=e,()=>f);var te=h(B,2),Ne=b(te);Ne.__click=Le,g(te),R(te,e=>ce=e,()=>ce),g(ge),g(me),ke(()=>Ye(B,`display: ${D()?"none":"flex"};`)),Se("scroll",P,Pe),L(T,de),xe(),Z()}ye(["click","keydown"]);export{At as component};
