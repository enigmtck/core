import"../chunks/CWj6FrbW.js";import"../chunks/DNlpqXoR.js";import{p as le,o as ce,u as X,v as de,w as j,aH as fe,x as P,y as $,a as pe,z as v,aI as w,E as e,B as I,A as T,r as ge,J as b,D as g,aE as A,M as _e,aG as O,aJ as me,aK as ve}from"../chunks/CPBLXjHw.js";import{i as ue}from"../chunks/DQNDscH3.js";import{e as D,i as M}from"../chunks/J1mst6rE.js";import{s as U}from"../chunks/BjYZIULF.js";import{p as L}from"../chunks/CWmzcjye.js";import{i as Se}from"../chunks/DrWWy8Ha.js";import{s as ye,a as we}from"../chunks/DmKqPpxj.js";import"../chunks/Bp3pig_u.js";import{a as Z,e as ke}from"../chunks/CS4B0N_g.js";import{g as q}from"../chunks/CR2iVpIj.js";var he=j('<li class="svelte-1kh7jkw"><div class="svelte-1kh7jkw"><img alt="Profile" class="svelte-1kh7jkw"/></div> <div class="svelte-1kh7jkw"><span class="svelte-1kh7jkw"> </span> <span class="svelte-1kh7jkw"> </span></div></li>'),Ee=j('<li class="svelte-1kh7jkw"><div class="svelte-1kh7jkw"><img alt="Profile"/></div> <div class="svelte-1kh7jkw"><span class="svelte-1kh7jkw"> </span> <span class="svelte-1kh7jkw"> </span></div></li>'),be=j('<form id="message" method="POST"><label>Message <textarea name="message"></textarea></label> <button>Send Message</button></form>'),Ne=j('<li class="svelte-1kh7jkw"><span> </span> <span> </span> <span> </span></li>'),Te=j('<div class="contacts svelte-1kh7jkw"><ul class="svelte-1kh7jkw"></ul></div> <main class="svelte-1kh7jkw"><button>Process Queue</button> <ul class="svelte-1kh7jkw"></ul> <!> <ul class="svelte-1kh7jkw"></ul></main>',1);function Le(ee,se){le(se,!1);const K=()=>we(ke,"$enigmatickWasm",te),[te,ne]=ye(),t=I(),x=I();let h;ce(async()=>{console.debug(e(t)),console.debug(e(x)),e(t)&&e(x)&&(e(t)&&(h=e(t).get_state().get_olm_pickled_account(),e(t).get_followers().then(s=>{s&&(JSON.parse(s).forEach(a=>{a.id&&e(y).set(a.id,a)}),console.debug(e(y)),T(y,e(y)))}),e(t).get_following().then(s=>{s&&(JSON.parse(s).forEach(a=>{a.id&&e(y).set(a.id,a)}),console.debug(e(y)),T(y,e(y)))})),e(t).get_sessions().then(async c=>{var o;const s=JSON.parse(String(c));console.info("SESSIONS"),console.debug(s),(o=s.items)==null||o.forEach(async a=>{var n,_;if(typeof a.to=="string"){let u=await((n=e(t))==null?void 0:n.get_actor(a.to));const i=JSON.parse(String(u));let d;i.icon&&i.icon.type==="Image"&&(d=i.icon.url);let r,l;const p=a.instrument;p.content?p.type==="OlmSession"&&(l=p.uuid):Array.isArray(a.instrument)&&a.instrument.forEach(m=>{m.type==="OlmSession"&&(l=m.uuid)});const f=String(a.to);e(k).set(f,[f,await((_=e(t))==null?void 0:_.get_webfinger_from_id(f)),i.name,d,l,r]),T(k,e(k))}}),console.info(e(k))}),R())});function R(){var c;(c=e(t))==null||c.get_processing_queue().then(async s=>{var a;console.info("QUEUE"),console.debug(s);const o=JSON.parse(String(s));console.log(o),(a=o.items)==null||a.forEach(async n=>{var _,u;if(n.type==="EncryptedSession"){console.info("ENCRYPTED SESSION");let i=null,d=null;if(n.instrument&&n.instrument.forEach){n.instrument.forEach(f=>{console.info(`TYPE ${f.type}, CONTENT ${f.content}`),f.type==="IdentityKey"?i=f.content:f.type==="SessionKey"&&(d=f.content)});const r=n.attributedTo,l=JSON.parse(String(await((_=e(t))==null?void 0:_.get_actor(r))));let p;if(l.icon&&l.icon.type==="Image"&&(p=l.icon.url),i&&d){let f=(u=e(t))==null?void 0:u.create_olm_message(r,"SESSION_INIT",String(h),i,d);if(f){console.info("SESSION INIT"),console.info(f.message),console.info(f.session);const m=f.session;if(e(t)){let S=(await(await e(t).SendParams.new()).add_recipient_id(r,!1)).set_encrypted().set_identity_key(e(t).get_identity_public_key(String(h))).set_session_data(m).set_content(f.message);e(t).send_encrypted_note(S).then(async()=>{var B,H;const N=`${n.id}#processing`;(B=e(t))==null||B.resolve_processed_item(N).then(()=>{console.info(`QUEUE ITEM RESOLVED: ${N}`)}),e(k).set(r,[r,await((H=e(t))==null?void 0:H.get_webfinger_from_id(r)),l.name,p,void 0,m]),console.info("SESSION INIT SENT")})}}}}}else if(n.type==="EncryptedNote"&&(console.info("ENCRYPTED NOTE"),n.tag)){let i=null;if(n.tag.forEach(d=>{const r=d;r.type==="Mention"&&r.name===n.attributedTo&&r.value&&(i=r.value)}),e(t)&&i){let d,r;const l=n.attributedTo,p=JSON.parse(String(await e(t).get_actor(l)));let f;if(p.icon&&p.icon.type==="Image"&&(f=p.icon.url),n.instrument&&n.instrument.type=="OlmSession"){const S=n.instrument;console.warn(S),r=S.uuid}const m=e(t).decrypt_olm_message(n.attributedTo,n.content,String(h),String(i),d);if(m)if(console.info(`MESSAGE: ${m.message}`),m.message==="SESSION_INIT"){const S=e(t).create_olm_message(n.attributedTo,"SESSION_ACK",String(h),i,void 0,m.session);if(S){const N=(await(await e(t).SendParams.new()).add_recipient_id(n.attributedTo,!1)).set_encrypted().set_identity_key(e(t).get_identity_public_key(String(h))).set_session_data(S.session).set_session_uuid(r).set_content(S.message).resolves(`${n.id}#processing`);e(t).send_encrypted_note(N).then(()=>{console.info("SESSION ACK SENT")})}}else{const S=JSON.stringify({message:m.message,published:n.published});e(t).store_to_vault(S,n.attributedTo,`${n.id}#processing`,String(r),m.session,String(e(t).get_hash(new TextEncoder().encode(String(d))))).then(async()=>{var N;e(k).set(l,[l,await((N=e(t))==null?void 0:N.get_webfinger_from_id(l)),p.name,f,r,m.session]),console.info("STORED TO VAULT")})}}}})})}async function ae(c){let s=new FormData(c.target);const o=s.get("message");if(console.log(s),e(E)){const a=e(k).get(e(E));if(e(t)&&a){const[n,_,u,i,d,r]=a;if(r){const l=e(t).create_olm_message(e(E),String(o),String(h),void 0,void 0,r);if(console.debug(l),l){console.info("ENCRYPTED"),console.debug(l.message);const p=(await(await e(t).SendParams.new()).add_recipient_id(e(E),!1)).set_encrypted().set_identity_key(e(t).get_identity_public_key(String(h))).set_session_data(l.session).set_session_uuid(d).set_content(l.message);e(t).send_encrypted_note(p).then(()=>{console.log("NOTE SENT")})}}}}}async function oe(c){var o,a;T(E,c.target.dataset.recipient);let s=await((o=e(t))==null?void 0:o.get_vault(0,40,String(e(E))));if(console.log(`SELECTED: ${e(E)}`),console.log(`VAULT: ${s}`),T(Q,[]),s){let n=JSON.parse(s);console.info(n),(a=n.orderedItems)==null||a.forEach(_=>{})}}function ie(c,s){return c.preferredUsername.toLowerCase()<s.preferredUsername.toLowerCase()?-1:c.preferredUsername.toLowerCase()>s.preferredUsername.toLowerCase()?1:0}let k=I(new Map),E=I(null),Q=I([]),y=I(new Map);X(()=>K(),()=>{T(t,K())}),X(()=>Z,()=>{T(x,ge(Z).username)}),de(),Se();var W=Te(),C=fe(W),Y=v(C);D(Y,5,()=>(e(y),b(()=>Array.from(e(y).values()).sort(ie))),M,(c,s)=>{var o=he(),a=v(o),n=v(a);g(a);var _=w(a,2),u=v(_),i=v(u,!0);g(u);var d=w(u,2),r=v(d,!0);g(d),g(_),g(o),A(l=>{U(n,"src",(e(s),b(()=>{var p;return(p=e(s).icon)==null?void 0:p.url}))),O(i,(e(s),b(()=>e(s).name))),O(r,l)},[()=>(_e(q),e(s),b(()=>q(e(s))))]),$(c,o)}),g(Y),g(C);var F=w(C,2),V=v(F),J=w(V,2);D(J,5,()=>(e(k),b(()=>Array.from(e(k).values()))),M,(c,s)=>{var o=me(()=>ve(e(s),6));let a=()=>e(o)[0],n=()=>e(o)[1],_=()=>e(o)[2],u=()=>e(o)[3];var i=Ee(),d=v(i),r=v(d);g(d);var l=w(d,2),p=v(l),f=v(p,!0);g(p);var m=w(p,2),S=v(m,!0);g(m),g(l),g(i),A(()=>{U(i,"data-recipient",a()),U(r,"src",u()),O(f,_()),O(S,n())}),P("click",i,L(oe)),$(c,i)}),g(J);var G=w(J,2);{var re=c=>{var s=be();P("submit",s,L(ae)),$(c,s)};ue(G,c=>{e(E)&&c(re)})}var z=w(G,2);D(z,5,()=>e(Q),M,(c,s)=>{var o=Ne(),a=v(o),n=v(a,!0);g(a);var _=w(a,2),u=v(_,!0);g(_);var i=w(_,2),d=v(i,!0);g(i),g(o),A(()=>{O(n,(e(s),b(()=>e(s).attributedTo))),O(u,(e(s),b(()=>e(s).published))),O(d,(e(s),b(()=>e(s).message)))}),$(c,o)}),g(z),g(F),P("click",V,L(R)),$(ee,W),pe(),ne()}export{Le as component};
