import"../chunks/CWj6FrbW.js";import{aG as Oe,p as Ye,o as Le,ax as Ze,y as C,r as a,v as o,aw as d,J as Re,aD as $,k as We,aB as O,q,ay as Be,n as Y,a as Ie,aj as w,aC as G,u as Q,aH as N}from"../chunks/C-PNKZ_s.js";import{i as pe}from"../chunks/CPpPu6cz.js";import{e as we,i as he}from"../chunks/gGHH_MYY.js";import{s as Je}from"../chunks/CGqlG8Jg.js";import{b as ge}from"../chunks/C6Vr0pnO.js";import{a as E,s as Ue}from"../chunks/ChSDbmkr.js";import{C as Ve,A as Fe}from"../chunks/CLkBcGVC.js";import{u as Ke,A as qe}from"../chunks/DqYft27y.js";import{b as Ge,g as Qe}from"../chunks/CjNKWMH0.js";import{h as ve,e as Ne,a as Xe}from"../chunks/n0qzx-_D.js";import"../chunks/CGsJVIYN.js";import{a as et,b as be,d as tt,D as ot,f as nt}from"../chunks/CT8Pszs0.js";import{p as at}from"../chunks/D7gh-3I6.js";import{H as st}from"../chunks/B4CkcLag.js";var rt=We('<!> <!> <main class="svelte-1fjec68"><div><div class="content-scroll svelte-1fjec68"><div class="scroll svelte-1fjec68" role="button" tabindex="0"><i class="fa-solid fa-chevron-up svelte-1fjec68"></i></div> <!></div></div></main>',1);function Tt(ye,_e){Ye(_e,!0);const Te=()=>E(Ne,"$enigmatickWasm",y),L=()=>E(at,"$page",y),X=()=>E(ve,"$hashtags",y),ee=()=>E(Ee,"$isSmallScreen",y),Ae=()=>E(Xe,"$appData",y),[y,$e]=Ue();let S=d(void 0),c=d(""),p=$(Te);const Ee=Ke("(max-width: 1200px)");Le(async()=>{window.addEventListener("scroll",oe),window.addEventListener("scroll",le);const e=()=>{const n=document.body.scrollHeight;document.documentElement.scrollHeight<n&&(document.documentElement.style.height=`${n}px`,document.documentElement.style.minHeight=`${n}px`)};e(),x=new ResizeObserver(()=>{e()}),document.body&&x.observe(document.body),z=new MutationObserver(()=>{e()}),document.body&&z.observe(document.body,{childList:!0,subtree:!0});const t=L().url.searchParams.get("view");t&&["home","local","direct","global"].includes(t)?a(c,t,!0):o(D)?a(c,"home"):a(c,"global"),await R(),await w(),e()});let x=null,z=null;Ze(()=>{window.removeEventListener("scroll",oe),window.removeEventListener("scroll",le),x&&x.disconnect(),z&&z.disconnect()});const Se=async e=>{if(console.debug(`Placing ${e.note.id}`),!e.note.inReplyTo&&e.note.id){o(i).has(e.note.id)||a(i,new Map(o(i)).set(e.note.id,e),!0),await Z(!0,0);return}const t=n=>{for(const[,s]of n.entries()){if(s.note.id===e.note.inReplyTo&&e.note.id)return s.replies.has(e.note.id)||s.replies.set(e.note.id,e),!0;if(t(s.replies))return!0}return!1};if(e.note.inReplyTo&&t(o(i))){a(i,new Map(o(i)),!0),await Z(!1);return}await Z(!1)},Z=async(e,t)=>{try{let n=re;if(a(i,o(i),!0),e&&t){for(let s=0;s<t;s++)await w();window.scrollTo({top:n,left:0,behavior:"instant"}),document.documentElement.scrollTop=n,document.body.scrollTop=n}}catch(n){console.error(n)}},te=async e=>{var t,n;if(console.debug(`Adding ${e.object.id}`),console.debug(e.object),e.object.attributedTo){console.debug(`Attributed to ${(t=e.object.ephemeral)==null?void 0:t.attributedTo}`);const s=tt((n=e.object.ephemeral)==null?void 0:n.attributedTo);if(s){const r=new ot(s,e.object,e);await Se(r)}}},R=async()=>{let e=0;if(o(i).forEach(t=>{t.note.inReplyTo||(e+=1)}),e<10)try{let t=await H();t&&t>0&&await R()}catch(t){console.error(t)}e>0&&a(j,!1)},H=async()=>{var n;let t=0;if(o(p)&&o(c)){ae||(ae=new(o(p)).EnigmatickCache);let s=await o(p).get_timeline(k,void 0,20,o(c),X());try{let r=JSON.parse(String(s));if(r.next){const l=et(r.next);l.type==="max"&&l.value&&(k=l.value)}try{(n=r.orderedItems)==null||n.forEach(l=>{te(l)}),a(j,!1)}catch(l){console.error(l)}return length}catch(r){for(console.error(r);t++<10;)await be(1e3),await H()}}else await be(500),await H()};Ge(async e=>{if(e.to&&e.to.route.id===null){let t=e.to.url.href;const n=/^https:\/\/(?:[a-zA-Z0-9\-]+)(?:\.[a-zA-Z0-9\-]+)+?\/@[a-zA-Z0-9_]+$/,s=/^https:\/\/(?:[a-zA-Z0-9\-]+)(?:\.[a-zA-Z0-9\-]+)+?\/tags\/([a-zA-Z0-9\-_]+)$/,r=/^https:\/\/(?:[a-zA-Z0-9\-]+)(?:\.[a-zA-Z0-9\-]+)+?\/search\?tag=([a-zA-Z0-9\-_]+)$/;let l;if(t.match(n)){let u=nt(t);u&&(e.cancel(),Qe(`/${u}`))}else((l=t.match(s))||(l=t.match(r)))&&(ve.update(u=>{const h=new Set(u);return h.add(l[1].toLowerCase()),h}),e.cancel())}});const xe=async()=>{var e;a(ke,null),a(_,null),(e=o(S))==null||e.resetCompose(),await ze(),J=!1},ze=async()=>{await w(),await w(),await w(),window.scrollTo({top:V,left:0,behavior:"instant"}),document.documentElement.scrollTop=V,document.body.scrollTop=V},W=async()=>{let e=window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;return await w(),await w(),await w(),window.scrollTo({top:0,left:0,behavior:"instant"}),document.documentElement.scrollTop=0,document.body.scrollTop=0,e},oe=async()=>{if(!M&&!J&&!o(_)){M=!0;const n=document.body.scrollHeight||document.documentElement.scrollHeight,s=window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;let r=1;for(;!J&&s+window.innerHeight>=n*.9&&r>0;)r=await H()||0;M=!1}const e=document.getElementsByClassName("scroll")[0];(window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0)<50?e.style.display="none":e.style.display="flex"},He=async e=>{o(p)&&!U.has(e)&&U.set(e,o(p).get_note(e));const t=U.get(e);return t&&t instanceof Promise?await t:t},Me=async(e,t,n,s,r,l,u)=>{var h;if(o(p)){let m=(await o(p).SendParams.new()).set_content(n);u||m.set_public(),m.set_attachments(JSON.stringify(s)),m.set_hashtags(l);for(const[A,g]of r)m.add_mention(A,g.id||"",((h=g.capabilities)==null?void 0:h.enigmatickEncryption)||!1);return t&&(m.set_in_reply_to(String(t.note.id)),m.set_conversation(String(t.note.conversation))),await o(p).send_note(m)}else return null},je=()=>{},v=async()=>{xe(),a(i,new Map,!0),a(j,!0),await W(),k=void 0;const e=document.getElementsByClassName("scroll")[0];e.style.display="none",await R()};let B=d(!0);C(()=>{if(ee()){a(B,!1);return}{a(B,!0);return}}),C(()=>{const e=L().url.searchParams.get("view");e&&["home","local","direct","global"].includes(e)?o(c)!==e&&(a(c,e,!0),v()):L().url.searchParams.has("view")||(o(D)&&o(c)!=="home"?(a(c,"home"),v()):!o(D)&&o(c)!=="global"&&(a(c,"global"),v()))});let I=d(null),ne=d(!0);C(()=>{const e=X(),t=Array.from(e).sort().join(",");if(o(ne)){(o(i).size>0||k!==void 0)&&(a(ne,!1),a(I,t,!0));return}o(I)!==t&&(a(I,t,!0),v())});let b=d(null);C(()=>{const e=o(D);o(b)===null&&e!==null?(a(b,e,!0),v()):o(b)!==e?(a(b,e,!0),v()):o(b)===null&&a(b,e,!0)});let ae=null,J=!1,i=d(Re(new Map)),se=$(()=>(o(i).size,Array.from(o(i).values()))),M=!1,j=d(!0),k,U=new Map,D=$(()=>Ae().username),_=d(null),ke=d(null),V=0,re=0,T=[];const le=()=>{!M&&!o(_)&&(re=window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0)};var ie=rt(),ce=O(ie);{let e=$(()=>o(c)==="direct");ge(Ve(ce,{senderFunction:Me,onPublish:t=>te(t.activity),get direct(){return o(e)}}),t=>a(S,t,!0),()=>o(S))}var de=G(ce,2);st(de,{});var ue=G(de,2),F=q(ue);let me;var fe=q(F),K=q(fe);K.__click=W,K.__keydown=e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),W())};var De=G(K,2);{var Pe=e=>{var t=N(),n=O(t);we(n,16,()=>Array(3),he,(s,r)=>{qe(s)}),Y(e,t)},Ce=e=>{var t=N(),n=O(t);we(n,17,()=>o(se),he,(s,r,l)=>{var u=N(),h=O(u);{var m=A=>{{let g=$(()=>{var f;return(f=o(S))==null?void 0:f.handleReplyToMessage});ge(Fe(A,{get parentArticle(){return T[l]},remove:je,get note(){return o(r)},get onReplyTo(){return o(g)},cachedNote:He}),(f,P)=>T[P]=f,f=>T==null?void 0:T[f],()=>[l])}};pe(h,A=>{var g,f,P;(g=o(r))!=null&&g.note&&(!o(_)&&(!o(r).note.inReplyTo||(P=(f=o(r).note.ephemeral)==null?void 0:f.announces)!=null&&P.length)||o(r).note.id==o(_))&&A(m)})}Y(s,u)}),Y(e,t)};pe(De,e=>{o(j)&&o(se).length===0?e(Pe):e(Ce,!1)})}Q(fe),Q(F),Q(ue),Be(()=>me=Je(F,1,"content svelte-1fjec68",null,me,{"filters-hidden":!o(B)&&!ee()})),Y(ye,ie),Ie(),$e()}Oe(["click","keydown"]);export{Tt as component};
