import{s as se,f as O,a as C,g as k,h as P,d as w,c as L,u as te,j as S,i as U,v,D as Y,E as W,G as Q,I as K,w as ne,o as le,x as ae,l as J,m as V,F as G,n as R}from"../chunks/scheduler.tnyNm5U0.js";import{e as F}from"../chunks/each.-oqiv04n.js";import{S as oe,i as ie}from"../chunks/index.R_ElRwcJ.js";import"../chunks/paths.oHFF0kpm.js";import{e as re,a as ce}from"../chunks/stores.bABpd-zC.js";import{g as $}from"../chunks/common.wRqRBlgV.js";function j(f,s,i){const e=f.slice();return e[11]=s[i],e}function B(f,s,i){const e=f.slice();return e[14]=s[i][0],e[15]=s[i][1],e[16]=s[i][2],e[17]=s[i][3],e[18]=s[i][4],e[19]=s[i][5],e}function z(f,s,i){const e=f.slice();return e[22]=s[i],e}function X(f){let s,i,e,g,E,_,y,N=f[22].name+"",A,b,p,T=$(f[22])+"",I,h;return{c(){s=O("li"),i=O("div"),e=O("img"),E=C(),_=O("div"),y=O("span"),A=J(N),b=C(),p=O("span"),I=J(T),h=C(),this.h()},l(l){s=k(l,"LI",{class:!0});var a=P(s);i=k(a,"DIV",{class:!0});var r=P(i);e=k(r,"IMG",{src:!0,alt:!0,class:!0}),r.forEach(w),E=L(a),_=k(a,"DIV",{class:!0});var o=P(_);y=k(o,"SPAN",{class:!0});var c=P(y);A=V(c,N),c.forEach(w),b=L(o),p=k(o,"SPAN",{class:!0});var m=P(p);I=V(m,T),m.forEach(w),o.forEach(w),h=L(a),a.forEach(w),this.h()},h(){G(e.src,g=f[22].icon?.url)||S(e,"src",g),S(e,"alt","Profile"),S(e,"class","svelte-2i5473"),S(i,"class","svelte-2i5473"),S(y,"class","svelte-2i5473"),S(p,"class","svelte-2i5473"),S(_,"class","svelte-2i5473"),S(s,"class","svelte-2i5473")},m(l,a){U(l,s,a),v(s,i),v(i,e),v(s,E),v(s,_),v(_,y),v(y,A),v(_,b),v(_,p),v(p,I),v(s,h)},p(l,a){a&8&&!G(e.src,g=l[22].icon?.url)&&S(e,"src",g),a&8&&N!==(N=l[22].name+"")&&R(A,N),a&8&&T!==(T=$(l[22])+"")&&R(I,T)},d(l){l&&w(s)}}}function Z(f){let s,i,e,g,E,_,y,N=f[16]+"",A,b,p,T=f[15]+"",I,h,l,a,r;return{c(){s=O("li"),i=O("div"),e=O("img"),E=C(),_=O("div"),y=O("span"),A=J(N),b=C(),p=O("span"),I=J(T),h=C(),this.h()},l(o){s=k(o,"LI",{"data-recipient":!0,class:!0});var c=P(s);i=k(c,"DIV",{class:!0});var m=P(i);e=k(m,"IMG",{alt:!0,src:!0,class:!0}),m.forEach(w),E=L(c),_=k(c,"DIV",{class:!0});var n=P(_);y=k(n,"SPAN",{class:!0});var d=P(y);A=V(d,N),d.forEach(w),b=L(n),p=k(n,"SPAN",{class:!0});var t=P(p);I=V(t,T),t.forEach(w),n.forEach(w),h=L(c),c.forEach(w),this.h()},h(){S(e,"alt","Profile"),G(e.src,g=f[17])||S(e,"src",g),S(e,"class","svelte-2i5473"),S(i,"class","svelte-2i5473"),S(y,"class","svelte-2i5473"),S(p,"class","svelte-2i5473"),S(_,"class","svelte-2i5473"),S(s,"data-recipient",l=f[14]),S(s,"class","svelte-2i5473")},m(o,c){U(o,s,c),v(s,i),v(i,e),v(s,E),v(s,_),v(_,y),v(y,A),v(_,b),v(_,p),v(p,I),v(s,h),a||(r=Y(s,"click",W(f[6])),a=!0)},p(o,c){c&1&&!G(e.src,g=o[17])&&S(e,"src",g),c&1&&N!==(N=o[16]+"")&&R(A,N),c&1&&T!==(T=o[15]+"")&&R(I,T),c&1&&l!==(l=o[14])&&S(s,"data-recipient",l)},d(o){o&&w(s),a=!1,r()}}}function x(f){let s,i=`<label>Message
				<textarea name="message"></textarea></label> <button>Send Message</button>`,e,g;return{c(){s=O("form"),s.innerHTML=i,this.h()},l(E){s=k(E,"FORM",{id:!0,method:!0,"data-svelte-h":!0}),te(s)!=="svelte-oyax26"&&(s.innerHTML=i),this.h()},h(){S(s,"id","message"),S(s,"method","POST")},m(E,_){U(E,s,_),e||(g=Y(s,"submit",W(f[5])),e=!0)},p:Q,d(E){E&&w(s),e=!1,g()}}}function q(f){let s,i,e=f[11].attributedTo+"",g,E,_,y=f[11].published+"",N,A,b,p=f[11].message+"",T,I;return{c(){s=O("li"),i=O("span"),g=J(e),E=C(),_=O("span"),N=J(y),A=C(),b=O("span"),T=J(p),I=C(),this.h()},l(h){s=k(h,"LI",{class:!0});var l=P(s);i=k(l,"SPAN",{class:!0});var a=P(i);g=V(a,e),a.forEach(w),E=L(l),_=k(l,"SPAN",{class:!0});var r=P(_);N=V(r,y),r.forEach(w),A=L(l),b=k(l,"SPAN",{class:!0});var o=P(b);T=V(o,p),o.forEach(w),I=L(l),l.forEach(w),this.h()},h(){S(i,"class","svelte-2i5473"),S(_,"class","svelte-2i5473"),S(b,"class","svelte-2i5473"),S(s,"class","svelte-2i5473")},m(h,l){U(h,s,l),v(s,i),v(i,g),v(s,E),v(s,_),v(_,N),v(s,A),v(s,b),v(b,T),v(s,I)},p(h,l){l&4&&e!==(e=h[11].attributedTo+"")&&R(g,e),l&4&&y!==(y=h[11].published+"")&&R(N,y),l&4&&p!==(p=h[11].message+"")&&R(T,p)},d(h){h&&w(s)}}}function fe(f){let s,i,e,g,E,_="Process Queue",y,N,A,b,p,T,I,h=F(Array.from(f[3].values()).sort(ee)),l=[];for(let n=0;n<h.length;n+=1)l[n]=X(z(f,h,n));let a=F(Array.from(f[0].values())),r=[];for(let n=0;n<a.length;n+=1)r[n]=Z(B(f,a,n));let o=f[1]&&x(f),c=F(f[2]),m=[];for(let n=0;n<c.length;n+=1)m[n]=q(j(f,c,n));return{c(){s=O("div"),i=O("ul");for(let n=0;n<l.length;n+=1)l[n].c();e=C(),g=O("main"),E=O("button"),E.textContent=_,y=C(),N=O("ul");for(let n=0;n<r.length;n+=1)r[n].c();A=C(),o&&o.c(),b=C(),p=O("ul");for(let n=0;n<m.length;n+=1)m[n].c();this.h()},l(n){s=k(n,"DIV",{class:!0});var d=P(s);i=k(d,"UL",{class:!0});var t=P(i);for(let M=0;M<l.length;M+=1)l[M].l(t);t.forEach(w),d.forEach(w),e=L(n),g=k(n,"MAIN",{class:!0});var u=P(g);E=k(u,"BUTTON",{"data-svelte-h":!0}),te(E)!=="svelte-1bmn755"&&(E.textContent=_),y=L(u),N=k(u,"UL",{class:!0});var D=P(N);for(let M=0;M<r.length;M+=1)r[M].l(D);D.forEach(w),A=L(u),o&&o.l(u),b=L(u),p=k(u,"UL",{class:!0});var H=P(p);for(let M=0;M<m.length;M+=1)m[M].l(H);H.forEach(w),u.forEach(w),this.h()},h(){S(i,"class","svelte-2i5473"),S(s,"class","contacts svelte-2i5473"),S(N,"class","svelte-2i5473"),S(p,"class","svelte-2i5473"),S(g,"class","svelte-2i5473")},m(n,d){U(n,s,d),v(s,i);for(let t=0;t<l.length;t+=1)l[t]&&l[t].m(i,null);U(n,e,d),U(n,g,d),v(g,E),v(g,y),v(g,N);for(let t=0;t<r.length;t+=1)r[t]&&r[t].m(N,null);v(g,A),o&&o.m(g,null),v(g,b),v(g,p);for(let t=0;t<m.length;t+=1)m[t]&&m[t].m(p,null);T||(I=Y(E,"click",W(f[4])),T=!0)},p(n,[d]){if(d&8){h=F(Array.from(n[3].values()).sort(ee));let t;for(t=0;t<h.length;t+=1){const u=z(n,h,t);l[t]?l[t].p(u,d):(l[t]=X(u),l[t].c(),l[t].m(i,null))}for(;t<l.length;t+=1)l[t].d(1);l.length=h.length}if(d&65){a=F(Array.from(n[0].values()));let t;for(t=0;t<a.length;t+=1){const u=B(n,a,t);r[t]?r[t].p(u,d):(r[t]=Z(u),r[t].c(),r[t].m(N,null))}for(;t<r.length;t+=1)r[t].d(1);r.length=a.length}if(n[1]?o?o.p(n,d):(o=x(n),o.c(),o.m(g,b)):o&&(o.d(1),o=null),d&4){c=F(n[2]);let t;for(t=0;t<c.length;t+=1){const u=j(n,c,t);m[t]?m[t].p(u,d):(m[t]=q(u),m[t].c(),m[t].m(p,null))}for(;t<m.length;t+=1)m[t].d(1);m.length=c.length}},i:Q,o:Q,d(n){n&&(w(s),w(e),w(g)),K(l,n),K(r,n),o&&o.d(),K(m,n),T=!1,I()}}}function ee(f,s){return f.preferredUsername.toLowerCase()<s.preferredUsername.toLowerCase()?-1:f.preferredUsername.toLowerCase()>s.preferredUsername.toLowerCase()?1:0}function de(f,s,i){let e,g,E;ne(f,re,h=>i(7,E=h));let _;le(async()=>{console.debug(e),console.debug(g),e&&g&&(e&&(_=e.get_state().get_olm_pickled_account(),e.get_followers().then(l=>{l&&(JSON.parse(l).forEach(r=>{r.id&&I.set(r.id,r)}),console.debug(I),i(3,I))}),e.get_following().then(l=>{l&&(JSON.parse(l).forEach(r=>{r.id&&I.set(r.id,r)}),console.debug(I),i(3,I))})),e.get_sessions().then(async h=>{const l=JSON.parse(String(h));console.info("SESSIONS"),console.debug(l),l.items?.forEach(async a=>{if(typeof a.to=="string"){let r=await e?.get_actor(a.to);const o=JSON.parse(String(r));let c;o.icon&&o.icon.type==="Image"&&(c=o.icon.url);let m,n;const d=a.instrument;d.content?d.type==="OlmSession"&&(n=d.uuid):Array.isArray(a.instrument)&&a.instrument.forEach(u=>{u.type==="OlmSession"&&(n=u.uuid)});const t=String(a.to);b.set(t,[t,await e?.get_webfinger_from_id(t),o.name,c,n,m]),i(0,b)}}),console.info(b)}),y())});function y(){e?.get_processing_queue().then(async h=>{console.info("QUEUE"),console.debug(h);const l=JSON.parse(String(h));console.log(l),l.items?.forEach(async a=>{if(a.type==="EncryptedSession"){console.info("ENCRYPTED SESSION");let r=null,o=null;if(a.instrument&&a.instrument.forEach){a.instrument.forEach(d=>{console.info(`TYPE ${d.type}, CONTENT ${d.content}`),d.type==="IdentityKey"?r=d.content:d.type==="SessionKey"&&(o=d.content)});const c=a.attributedTo,m=JSON.parse(String(await e?.get_actor(c)));let n;if(m.icon&&m.icon.type==="Image"&&(n=m.icon.url),r&&o){let d=e?.create_olm_message(c,"SESSION_INIT",String(_),r,o);if(d){console.info("SESSION INIT"),console.info(d.message),console.info(d.session);const t=d.session;if(e){let u=(await(await e.SendParams.new()).add_recipient_id(c,!1)).set_encrypted().set_identity_key(e.get_identity_public_key(String(_))).set_session_data(t).set_content(d.message);e.send_encrypted_note(u).then(async()=>{const D=`${a.id}#processing`;e?.resolve_processed_item(D).then(()=>{console.info(`QUEUE ITEM RESOLVED: ${D}`)}),b.set(c,[c,await e?.get_webfinger_from_id(c),m.name,n,void 0,t]),console.info("SESSION INIT SENT")})}}}}}else if(a.type==="EncryptedNote"&&(console.info("ENCRYPTED NOTE"),a.tag)){let r=null;if(a.tag.forEach(o=>{const c=o;c.type==="Mention"&&c.name===a.attributedTo&&c.value&&(r=c.value)}),e&&r){let o,c;const m=a.attributedTo,n=JSON.parse(String(await e.get_actor(m)));let d;if(n.icon&&n.icon.type==="Image"&&(d=n.icon.url),a.instrument&&a.instrument.type=="OlmSession"){const u=a.instrument;console.warn(u),c=u.uuid}const t=e.decrypt_olm_message(a.attributedTo,a.content,String(_),String(r),o);if(t)if(console.info(`MESSAGE: ${t.message}`),t.message==="SESSION_INIT"){const u=e.create_olm_message(a.attributedTo,"SESSION_ACK",String(_),r,void 0,t.session);if(u){const D=(await(await e.SendParams.new()).add_recipient_id(a.attributedTo,!1)).set_encrypted().set_identity_key(e.get_identity_public_key(String(_))).set_session_data(u.session).set_session_uuid(c).set_content(u.message).resolves(`${a.id}#processing`);e.send_encrypted_note(D).then(()=>{console.info("SESSION ACK SENT")})}}else{const u=JSON.stringify({message:t.message,published:a.published});e.store_to_vault(u,a.attributedTo,`${a.id}#processing`,String(c),t.session,String(e.get_hash(new TextEncoder().encode(String(o))))).then(async()=>{b.set(m,[m,await e?.get_webfinger_from_id(m),n.name,d,c,t.session]),console.info("STORED TO VAULT")})}}}})})}async function N(h){let l=new FormData(h.target);const a=l.get("message");if(console.log(l),p){const r=b.get(p);if(e&&r){const[o,c,m,n,d,t]=r;if(t){const u=e.create_olm_message(p,String(a),String(_),void 0,void 0,t);if(console.debug(u),u){console.info("ENCRYPTED"),console.debug(u.message);const D=(await(await e.SendParams.new()).add_recipient_id(p,!1)).set_encrypted().set_identity_key(e.get_identity_public_key(String(_))).set_session_data(u.session).set_session_uuid(d).set_content(u.message);e.send_encrypted_note(D).then(()=>{console.log("NOTE SENT")})}}}}}async function A(h){i(1,p=h.target.dataset.recipient);let l=await e?.get_vault(0,40,String(p));if(console.log(`SELECTED: ${p}`),console.log(`VAULT: ${l}`),i(2,T=[]),l){let a=JSON.parse(l);console.info(a),a.orderedItems?.forEach(r=>{})}}let b=new Map,p=null,T=[],I=new Map;return f.$$.update=()=>{f.$$.dirty&128&&(e=E)},g=ae(ce).username,[b,p,T,I,y,N,A,E]}class ve extends oe{constructor(s){super(),ie(this,s,de,fe,se,{})}}export{ve as component};
