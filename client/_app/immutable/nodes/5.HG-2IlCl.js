import{S as se,i as ne,s as le,n as Y,d as T,N as Q,b as J,c as v,m as W,G as H,o as S,e as k,f as w,h as L,z as te,j as A,k as M,l as oe,q as ae,p as ie,K as G,a as V,g as R,t as K}from"../chunks/Bme_sf2i.js";import{e as F,g as $}from"../chunks/DD9C-qjT.js";import"../chunks/IHki7fMi.js";import"../chunks/C2jeIaVt.js";import{e as re,a as ce}from"../chunks/BigVxDb3.js";function j(c,s,a){const e=c.slice();return e[11]=s[a],e}function z(c,s,a){const e=c.slice();return e[14]=s[a][0],e[15]=s[a][1],e[16]=s[a][2],e[17]=s[a][3],e[18]=s[a][4],e[19]=s[a][5],e}function B(c,s,a){const e=c.slice();return e[22]=s[a],e}function X(c){let s,a,e,g,E,f,y,N=c[22].name+"",P,b,p,O=$(c[22])+"",I,h;return{c(){s=A("li"),a=A("div"),e=A("img"),E=M(),f=A("div"),y=A("span"),P=K(N),b=M(),p=A("span"),I=K(O),h=M(),this.h()},l(l){s=k(l,"LI",{class:!0});var d=w(s);a=k(d,"DIV",{class:!0});var n=w(a);e=k(n,"IMG",{src:!0,alt:!0,class:!0}),n.forEach(T),E=L(d),f=k(d,"DIV",{class:!0});var i=w(f);y=k(i,"SPAN",{class:!0});var u=w(y);P=R(u,N),u.forEach(T),b=L(i),p=k(i,"SPAN",{class:!0});var r=w(p);I=R(r,O),r.forEach(T),i.forEach(T),h=L(d),d.forEach(T),this.h()},h(){var l;G(e.src,g=(l=c[22].icon)==null?void 0:l.url)||S(e,"src",g),S(e,"alt","Profile"),S(e,"class","svelte-2i5473"),S(a,"class","svelte-2i5473"),S(y,"class","svelte-2i5473"),S(p,"class","svelte-2i5473"),S(f,"class","svelte-2i5473"),S(s,"class","svelte-2i5473")},m(l,d){J(l,s,d),v(s,a),v(a,e),v(s,E),v(s,f),v(f,y),v(y,P),v(f,b),v(f,p),v(p,I),v(s,h)},p(l,d){var n;d&8&&!G(e.src,g=(n=l[22].icon)==null?void 0:n.url)&&S(e,"src",g),d&8&&N!==(N=l[22].name+"")&&V(P,N),d&8&&O!==(O=$(l[22])+"")&&V(I,O)},d(l){l&&T(s)}}}function Z(c){let s,a,e,g,E,f,y,N=c[16]+"",P,b,p,O=c[15]+"",I,h,l,d,n;return{c(){s=A("li"),a=A("div"),e=A("img"),E=M(),f=A("div"),y=A("span"),P=K(N),b=M(),p=A("span"),I=K(O),h=M(),this.h()},l(i){s=k(i,"LI",{"data-recipient":!0,class:!0});var u=w(s);a=k(u,"DIV",{class:!0});var r=w(a);e=k(r,"IMG",{alt:!0,src:!0,class:!0}),r.forEach(T),E=L(u),f=k(u,"DIV",{class:!0});var o=w(f);y=k(o,"SPAN",{class:!0});var m=w(y);P=R(m,N),m.forEach(T),b=L(o),p=k(o,"SPAN",{class:!0});var t=w(p);I=R(t,O),t.forEach(T),o.forEach(T),h=L(u),u.forEach(T),this.h()},h(){S(e,"alt","Profile"),G(e.src,g=c[17])||S(e,"src",g),S(e,"class","svelte-2i5473"),S(a,"class","svelte-2i5473"),S(y,"class","svelte-2i5473"),S(p,"class","svelte-2i5473"),S(f,"class","svelte-2i5473"),S(s,"data-recipient",l=c[14]),S(s,"class","svelte-2i5473")},m(i,u){J(i,s,u),v(s,a),v(a,e),v(s,E),v(s,f),v(f,y),v(y,P),v(f,b),v(f,p),v(p,I),v(s,h),d||(n=W(s,"click",H(c[6])),d=!0)},p(i,u){u&1&&!G(e.src,g=i[17])&&S(e,"src",g),u&1&&N!==(N=i[16]+"")&&V(P,N),u&1&&O!==(O=i[15]+"")&&V(I,O),u&1&&l!==(l=i[14])&&S(s,"data-recipient",l)},d(i){i&&T(s),d=!1,n()}}}function x(c){let s,a=`<label>Message
				<textarea name="message"></textarea></label> <button>Send Message</button>`,e,g;return{c(){s=A("form"),s.innerHTML=a,this.h()},l(E){s=k(E,"FORM",{id:!0,method:!0,"data-svelte-h":!0}),te(s)!=="svelte-oyax26"&&(s.innerHTML=a),this.h()},h(){S(s,"id","message"),S(s,"method","POST")},m(E,f){J(E,s,f),e||(g=W(s,"submit",H(c[5])),e=!0)},p:Y,d(E){E&&T(s),e=!1,g()}}}function q(c){let s,a,e=c[11].attributedTo+"",g,E,f,y=c[11].published+"",N,P,b,p=c[11].message+"",O,I;return{c(){s=A("li"),a=A("span"),g=K(e),E=M(),f=A("span"),N=K(y),P=M(),b=A("span"),O=K(p),I=M(),this.h()},l(h){s=k(h,"LI",{class:!0});var l=w(s);a=k(l,"SPAN",{class:!0});var d=w(a);g=R(d,e),d.forEach(T),E=L(l),f=k(l,"SPAN",{class:!0});var n=w(f);N=R(n,y),n.forEach(T),P=L(l),b=k(l,"SPAN",{class:!0});var i=w(b);O=R(i,p),i.forEach(T),I=L(l),l.forEach(T),this.h()},h(){S(a,"class","svelte-2i5473"),S(f,"class","svelte-2i5473"),S(b,"class","svelte-2i5473"),S(s,"class","svelte-2i5473")},m(h,l){J(h,s,l),v(s,a),v(a,g),v(s,E),v(s,f),v(f,N),v(s,P),v(s,b),v(b,O),v(s,I)},p(h,l){l&4&&e!==(e=h[11].attributedTo+"")&&V(g,e),l&4&&y!==(y=h[11].published+"")&&V(N,y),l&4&&p!==(p=h[11].message+"")&&V(O,p)},d(h){h&&T(s)}}}function fe(c){let s,a,e,g,E,f="Process Queue",y,N,P,b,p,O,I,h=F(Array.from(c[3].values()).sort(ee)),l=[];for(let o=0;o<h.length;o+=1)l[o]=X(B(c,h,o));let d=F(Array.from(c[0].values())),n=[];for(let o=0;o<d.length;o+=1)n[o]=Z(z(c,d,o));let i=c[1]&&x(c),u=F(c[2]),r=[];for(let o=0;o<u.length;o+=1)r[o]=q(j(c,u,o));return{c(){s=A("div"),a=A("ul");for(let o=0;o<l.length;o+=1)l[o].c();e=M(),g=A("main"),E=A("button"),E.textContent=f,y=M(),N=A("ul");for(let o=0;o<n.length;o+=1)n[o].c();P=M(),i&&i.c(),b=M(),p=A("ul");for(let o=0;o<r.length;o+=1)r[o].c();this.h()},l(o){s=k(o,"DIV",{class:!0});var m=w(s);a=k(m,"UL",{class:!0});var t=w(a);for(let U=0;U<l.length;U+=1)l[U].l(t);t.forEach(T),m.forEach(T),e=L(o),g=k(o,"MAIN",{class:!0});var _=w(g);E=k(_,"BUTTON",{"data-svelte-h":!0}),te(E)!=="svelte-1bmn755"&&(E.textContent=f),y=L(_),N=k(_,"UL",{class:!0});var C=w(N);for(let U=0;U<n.length;U+=1)n[U].l(C);C.forEach(T),P=L(_),i&&i.l(_),b=L(_),p=k(_,"UL",{class:!0});var D=w(p);for(let U=0;U<r.length;U+=1)r[U].l(D);D.forEach(T),_.forEach(T),this.h()},h(){S(a,"class","svelte-2i5473"),S(s,"class","contacts svelte-2i5473"),S(N,"class","svelte-2i5473"),S(p,"class","svelte-2i5473"),S(g,"class","svelte-2i5473")},m(o,m){J(o,s,m),v(s,a);for(let t=0;t<l.length;t+=1)l[t]&&l[t].m(a,null);J(o,e,m),J(o,g,m),v(g,E),v(g,y),v(g,N);for(let t=0;t<n.length;t+=1)n[t]&&n[t].m(N,null);v(g,P),i&&i.m(g,null),v(g,b),v(g,p);for(let t=0;t<r.length;t+=1)r[t]&&r[t].m(p,null);O||(I=W(E,"click",H(c[4])),O=!0)},p(o,[m]){if(m&8){h=F(Array.from(o[3].values()).sort(ee));let t;for(t=0;t<h.length;t+=1){const _=B(o,h,t);l[t]?l[t].p(_,m):(l[t]=X(_),l[t].c(),l[t].m(a,null))}for(;t<l.length;t+=1)l[t].d(1);l.length=h.length}if(m&65){d=F(Array.from(o[0].values()));let t;for(t=0;t<d.length;t+=1){const _=z(o,d,t);n[t]?n[t].p(_,m):(n[t]=Z(_),n[t].c(),n[t].m(N,null))}for(;t<n.length;t+=1)n[t].d(1);n.length=d.length}if(o[1]?i?i.p(o,m):(i=x(o),i.c(),i.m(g,b)):i&&(i.d(1),i=null),m&4){u=F(o[2]);let t;for(t=0;t<u.length;t+=1){const _=j(o,u,t);r[t]?r[t].p(_,m):(r[t]=q(_),r[t].c(),r[t].m(p,null))}for(;t<r.length;t+=1)r[t].d(1);r.length=u.length}},i:Y,o:Y,d(o){o&&(T(s),T(e),T(g)),Q(l,o),Q(n,o),i&&i.d(),Q(r,o),O=!1,I()}}}function ee(c,s){return c.preferredUsername.toLowerCase()<s.preferredUsername.toLowerCase()?-1:c.preferredUsername.toLowerCase()>s.preferredUsername.toLowerCase()?1:0}function de(c,s,a){let e,g,E;oe(c,re,h=>a(7,E=h));let f;ae(async()=>{console.debug(e),console.debug(g),e&&g&&(e&&(f=e.get_state().get_olm_pickled_account(),e.get_followers().then(l=>{l&&(JSON.parse(l).forEach(n=>{n.id&&I.set(n.id,n)}),console.debug(I),a(3,I))}),e.get_following().then(l=>{l&&(JSON.parse(l).forEach(n=>{n.id&&I.set(n.id,n)}),console.debug(I),a(3,I))})),e.get_sessions().then(async h=>{var d;const l=JSON.parse(String(h));console.info("SESSIONS"),console.debug(l),(d=l.items)==null||d.forEach(async n=>{if(typeof n.to=="string"){let i=await(e==null?void 0:e.get_actor(n.to));const u=JSON.parse(String(i));let r;u.icon&&u.icon.type==="Image"&&(r=u.icon.url);let o,m;const t=n.instrument;t.content?t.type==="OlmSession"&&(m=t.uuid):Array.isArray(n.instrument)&&n.instrument.forEach(C=>{C.type==="OlmSession"&&(m=C.uuid)});const _=String(n.to);b.set(_,[_,await(e==null?void 0:e.get_webfinger_from_id(_)),u.name,r,m,o]),a(0,b)}}),console.info(b)}),y())});function y(){e==null||e.get_processing_queue().then(async h=>{var d;console.info("QUEUE"),console.debug(h);const l=JSON.parse(String(h));console.log(l),(d=l.items)==null||d.forEach(async n=>{if(n.type==="EncryptedSession"){console.info("ENCRYPTED SESSION");let i=null,u=null;if(n.instrument&&n.instrument.forEach){n.instrument.forEach(t=>{console.info(`TYPE ${t.type}, CONTENT ${t.content}`),t.type==="IdentityKey"?i=t.content:t.type==="SessionKey"&&(u=t.content)});const r=n.attributedTo,o=JSON.parse(String(await(e==null?void 0:e.get_actor(r))));let m;if(o.icon&&o.icon.type==="Image"&&(m=o.icon.url),i&&u){let t=e==null?void 0:e.create_olm_message(r,"SESSION_INIT",String(f),i,u);if(t){console.info("SESSION INIT"),console.info(t.message),console.info(t.session);const _=t.session;if(e){let C=(await(await e.SendParams.new()).add_recipient_id(r,!1)).set_encrypted().set_identity_key(e.get_identity_public_key(String(f))).set_session_data(_).set_content(t.message);e.send_encrypted_note(C).then(async()=>{const D=`${n.id}#processing`;e==null||e.resolve_processed_item(D).then(()=>{console.info(`QUEUE ITEM RESOLVED: ${D}`)}),b.set(r,[r,await(e==null?void 0:e.get_webfinger_from_id(r)),o.name,m,void 0,_]),console.info("SESSION INIT SENT")})}}}}}else if(n.type==="EncryptedNote"&&(console.info("ENCRYPTED NOTE"),n.tag)){let i=null;if(n.tag.forEach(u=>{const r=u;r.type==="Mention"&&r.name===n.attributedTo&&r.value&&(i=r.value)}),e&&i){let u,r;const o=n.attributedTo,m=JSON.parse(String(await e.get_actor(o)));let t;if(m.icon&&m.icon.type==="Image"&&(t=m.icon.url),n.instrument&&n.instrument.type=="OlmSession"){const C=n.instrument;console.warn(C),r=C.uuid}const _=e.decrypt_olm_message(n.attributedTo,n.content,String(f),String(i),u);if(_)if(console.info(`MESSAGE: ${_.message}`),_.message==="SESSION_INIT"){const C=e.create_olm_message(n.attributedTo,"SESSION_ACK",String(f),i,void 0,_.session);if(C){const D=(await(await e.SendParams.new()).add_recipient_id(n.attributedTo,!1)).set_encrypted().set_identity_key(e.get_identity_public_key(String(f))).set_session_data(C.session).set_session_uuid(r).set_content(C.message).resolves(`${n.id}#processing`);e.send_encrypted_note(D).then(()=>{console.info("SESSION ACK SENT")})}}else{const C=JSON.stringify({message:_.message,published:n.published});e.store_to_vault(C,n.attributedTo,`${n.id}#processing`,String(r),_.session,String(e.get_hash(new TextEncoder().encode(String(u))))).then(async()=>{b.set(o,[o,await(e==null?void 0:e.get_webfinger_from_id(o)),m.name,t,r,_.session]),console.info("STORED TO VAULT")})}}}})})}async function N(h){let l=new FormData(h.target);const d=l.get("message");if(console.log(l),p){const n=b.get(p);if(e&&n){const[i,u,r,o,m,t]=n;if(t){const _=e.create_olm_message(p,String(d),String(f),void 0,void 0,t);if(console.debug(_),_){console.info("ENCRYPTED"),console.debug(_.message);const C=(await(await e.SendParams.new()).add_recipient_id(p,!1)).set_encrypted().set_identity_key(e.get_identity_public_key(String(f))).set_session_data(_.session).set_session_uuid(m).set_content(_.message);e.send_encrypted_note(C).then(()=>{console.log("NOTE SENT")})}}}}}async function P(h){var d;a(1,p=h.target.dataset.recipient);let l=await(e==null?void 0:e.get_vault(0,40,String(p)));if(console.log(`SELECTED: ${p}`),console.log(`VAULT: ${l}`),a(2,O=[]),l){let n=JSON.parse(l);console.info(n),(d=n.orderedItems)==null||d.forEach(i=>{})}}let b=new Map,p=null,O=[],I=new Map;return c.$$.update=()=>{c.$$.dirty&128&&(e=E)},g=ie(ce).username,[b,p,O,I,y,N,P,E]}class ve extends se{constructor(s){super(),ne(this,s,de,fe,le,{})}}export{ve as component};
