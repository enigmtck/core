import"../chunks/CWj6FrbW.js";import{p as ze,aC as C,S as Pe,I as B,E as o,A as i,o as He,aD as Ye,w as Z,aH as x,aE as le,y as O,a as Je,aJ as Q,aI as ie,z as H,D as Y,aM as U,aG as Me}from"../chunks/CPBLXjHw.js";import{i as q}from"../chunks/DQNDscH3.js";import{e as G,i as Ce}from"../chunks/J1mst6rE.js";import{s as Ke}from"../chunks/DSGZP5v2.js";import{a as J,s as Ve}from"../chunks/DmKqPpxj.js";import"../chunks/DNlpqXoR.js";import{u as Be,P as Oe}from"../chunks/CWFKWbqW.js";import"../chunks/Dgy-dwZ8.js";import{p as Qe}from"../chunks/DfJuBoyc.js";import{s as Ge,b as Ze,e as Xe}from"../chunks/CS4B0N_g.js";import{P as et}from"../chunks/B4BXaNBM.js";import"../chunks/xoSPiZpW.js";import{A as tt}from"../chunks/ClYLzRSr.js";import{H as rt}from"../chunks/CKBTCsS-.js";import{f as Ne,D as ot,g as st}from"../chunks/CR2iVpIj.js";var at=Z('<div class="error svelte-e12qt1"> </div>'),nt=Z('<div class="no-results svelte-e12qt1"> </div>'),ct=Z("<!> <!> <!>",1),lt=Z('<!> <main class="svelte-e12qt1"><div><div class="content-scroll svelte-e12qt1"><!></div></div></main>',1);function Tt(Ee,Ie){ze(Ie,!0);const xe=()=>J(Xe,"$enigmatickWasm",L),ue=()=>J(Ge,"$searchTypes",L),fe=()=>J(Ze,"$searchOrder",L),de=()=>J(ke,"$isSmallScreen",L),pe=()=>J(Qe,"$page",L),[L,Re]=Ve();let v=Q(xe);const ke=Be("(max-width: 1000px)");let P=C(""),ge=Q(ue),he=Q(fe),A=C(Pe({actors:[],objects:[]})),F=C(!1),K=C(!1),W=C(null),X=C(0),N=C(!0),V=C(!1),me=C(!1);B(()=>{const e=de();o(me)?!e&&!o(V)&&i(V,!0):(i(V,!e),i(me,!0))});const be=async e=>{if(!o(v)||!e.uri)return null;try{let t=null,a=null;console.log("Fetching object via WASM get_note:",e.uri);try{const c=await o(v).get_note(e.uri);if(c){console.log("✓ Successfully fetched object via WASM get_note:",e.uri);try{const s=JSON.parse(c);if(s.type==="Create"||s.type==="Announce"||s.type==="Update"?s.object?(t=s.object,s.to&&(t.to=s.to),s.cc&&(t.cc=s.cc),console.log(`✓ Object ${e.uri} was wrapped in Activity ${s.type}, extracted object`)):(t=s,console.log(`✓ Object ${e.uri} is an Activity, using Activity data`)):(t=s,console.log(`✓ Object ${e.uri} is object directly`)),t.ephemeral&&t.ephemeral.attributedTo&&console.log(`✓ Object ${e.uri} HAS ephemeral.attributedTo data - will use it for actor`),!t.to&&!t.cc&&console.warn(`Object ${e.uri} has no to/cc fields - visibility cannot be determined`),t.to||t.cc?console.log(`Object ${e.uri} has to:`,t.to,"cc:",t.cc):console.warn(`Object ${e.uri} missing to/cc fields - will be marked as non-public`),t.attributedTo&&(a=Ne(t.attributedTo)),!a&&t.ephemeral&&t.ephemeral.attributedTo){const r=Array.isArray(t.ephemeral.attributedTo)?t.ephemeral.attributedTo:[t.ephemeral.attributedTo];if(r.length>0){const l=r[0];typeof l=="object"&&l.id?(a=l.id,console.log("Extracted attributedTo from ephemeral.attributedTo:",a)):typeof l=="string"&&(a=l)}}}catch(s){console.warn("Failed to parse object JSON from WASM:",e.uri,s),t=null}}else console.warn("WASM get_note returned no data for:",e.uri),t=null}catch(c){console.error("WASM get_note failed for:",e.uri,c instanceof Error?c.message:c),t=null}if(t){if(!a){if(a=Ne(t.attributedTo),!a&&t.ephemeral&&t.ephemeral.attributedTo){const c=Array.isArray(t.ephemeral.attributedTo)?t.ephemeral.attributedTo:[t.ephemeral.attributedTo];if(c.length>0){const s=c[0];typeof s=="object"&&s.id?a=s.id:typeof s=="string"&&(a=s)}}if(!a)return console.warn("No attributedTo found for object:",e.uri),null}}else{let c=null;const s=e.uri.match(/^https?:\/\/([^/]+)\/users\/([^/]+)/);if(s){const[,r,l]=s;c=`https://${r}/users/${l}`}else try{const r=new URL(e.uri),l=r.pathname.match(/\/@([^/]+)/);if(l){const d=l[1];c=`${r.origin}/@${d}`,console.log("Extracted attributedTo from @username pattern in URI:",c)}else r.pathname==="/"&&r.searchParams.has("p")?(c=`${r.origin}/@blog`,console.log("WordPress query string pattern detected (?p=), using /@blog as attributedTo:",c)):r.pathname.match(/\/\d{4}\/\d{2}\//)?(c=`${r.origin}/@blog`,console.log("WordPress permalink pattern detected, using /@blog as attributedTo:",c)):r.pathname.split("/").filter(u=>u).length>0?(c=`${r.origin}/@blog`,console.warn("Could not extract attributedTo from URI pattern, using /@blog fallback for:",e.uri)):c=`${r.origin}/@blog`}catch(r){return console.warn("Failed to parse URI for fallback:",e.uri,r),null}c&&!a&&(a=c),t={"@context":"https://www.w3.org/ns/activitystreams",id:e.uri,type:e.object_type||"Note",content:e.content,published:e.published,url:e.url||e.uri,attributedTo:a||c,to:["https://www.w3.org/ns/activitystreams#Public"],cc:[],conversation:void 0},console.log("Using fallback: constructed object from search results for:",e.uri,"with attributedTo:",a)}let n;if(t&&t.ephemeral&&t.ephemeral.attributedTo){const c=Array.isArray(t.ephemeral.attributedTo)?t.ephemeral.attributedTo:[t.ephemeral.attributedTo];if(console.log(`Found ${c.length} actor(s) in ephemeral.attributedTo for object ${e.uri}, attributedTo=${a}`),a){const s=c.find(r=>typeof r=="string"?r===a:(r.id||r.url)===a);s&&typeof s=="object"?(n=s,n.id&&n.id!==a&&(a=n.id),console.log("✓ Using actor data from ephemeral.attributedTo (matched by ID):",n.name||n.preferredUsername,"id:",n.id)):console.log("No exact match found in ephemeral actors for:",a)}if(!n&&c.length>0){const s=c[0];typeof s=="object"&&s.id&&(n=s,a=n.id||null,console.log("✓ Using first actor from ephemeral.attributedTo (no ID match, using first):",n.name||n.preferredUsername,"id:",n.id))}}else console.log("No ephemeral.attributedTo found for object:",e.uri);if(!n&&o(v)&&a){E||(E=new(o(v)).EnigmatickCache);let c=$.get(a);c||(c=(async()=>{try{if(!o(v)||!E)return null;const r=o(v).get_actor_cached(E,a);if(!r)return null;const l=new Promise((u,y)=>setTimeout(()=>y(new Error("Timeout")),5e3)),d=await Promise.race([r,l]);if(d)try{const u=JSON.parse(d);return $.delete(a),u}catch{return $.delete(a),null}else return $.delete(a),null}catch{return $.delete(a),null}})(),$.set(a,c));const s=await c;s&&(n=s)}if(!n&&a&&(n=Fe(a),console.warn("Could not fetch actor for:",a,"- using minimal actor")),t){const c=["https://www.w3.org/ns/activitystreams#Public","as:Public","Public"],s=t.to?Array.isArray(t.to)?t.to:[t.to]:[],r=t.cc?Array.isArray(t.cc)?t.cc:[t.cc]:[],l=[...s,...r].map(u=>typeof u=="string"?u:u&&typeof u=="object"&&(u.href||u.id||u.url)||String(u)),d=l.some(u=>c.includes(u));console.log(`Creating DisplayNote for ${e.uri}:`,{to:t.to,cc:t.cc,recipientStrings:l,isPublic:d,hasTo:!!t.to,hasCc:!!t.cc}),!d&&(t.to||t.cc)&&console.warn(`Object ${e.uri} has to/cc but is not marked as public. Recipients:`,l)}if(!n)throw new Error("No actor found for object: "+e.uri);return new ot(n,t)}catch{return null}},z=e=>({"@context":"https://www.w3.org/ns/activitystreams",type:"Person",id:e.id,preferredUsername:e.username,name:e.display_name||e.username,url:e.url||e.id,inbox:`${e.id}/inbox`,outbox:`${e.id}/outbox`,followers:`${e.id}/followers`,following:`${e.id}/following`,publicKey:{id:`${e.id}#main-key`,owner:e.id,publicKeyPem:""},icon:e.avatar?{url:e.avatar}:void 0}),ye=async e=>{if(console.log("processActors called with",e.length,"actors, wasm available:",!!o(v)),!e||e.length===0)return[];if(!o(v))return console.warn("WASM not available, returning minimal actors"),e.map(n=>z(n));E||(E=new(o(v)).EnigmatickCache);const t=10,a=[];for(let n=0;n<e.length;n+=t){const c=e.slice(n,n+t),s=await Promise.allSettled(c.map(async r=>{try{let l=r.id;console.log("Processing actor from search result:",{id:l,acct:r.acct,url:r.url});const d=r.acct&&r.acct.startsWith("@")?r.acct:l;let u=$.get(d);u||(console.log("Fetching full actor object using get_actor_cached for:",d),u=(async()=>{try{const f=o(v).get_actor_cached(E,d);if(console.log("get_actor_cached returned promise:",!!f,"for:",d),!f){if(console.error("get_actor_cached returned null for:",d,"- cannot fetch full actor"),d!==l){console.log("Retrying with actor.id:",l);const p=o(v).get_actor_cached(E,l);if(p){const m=await p;if(m)return JSON.parse(m)}}return null}const h=new Promise((p,m)=>setTimeout(()=>m(new Error("Timeout waiting for actor fetch")),1e4)),M=await Promise.race([f,h]);if(console.log("Actor promise resolved for:",l,"hasData:",!!M),M)try{const p=JSON.parse(M);console.log("Fetched actor profile:",{id:p.id,name:p.name,hasSummary:!!p.summary,hasTags:!!p.tag,tagCount:p.tag?Array.isArray(p.tag)?p.tag.length:1:0}),p.ephemeral||(p.ephemeral={});const m=p.ephemeral;if(!m.webfinger){const R=p;if(R.webfinger)m.webfinger=R.webfinger;else try{const k=st(p);k&&k.startsWith("@")&&(m.webfinger=k)}catch{}}return $.delete(d),console.log("Successfully parsed full actor object:",p.id,"summary:",!!p.summary,"tags:",!!p.tag),p}catch(p){return console.error("Failed to parse actor JSON for:",d,p),$.delete(d),null}else return console.warn("Actor promise resolved but no data for:",d),$.delete(d),null}catch(f){return console.error("Error fetching actor for:",d,f),$.delete(d),null}})(),$.set(d,u));const y=await u;return y?(console.log("Successfully fetched full actor:",y.id,"hasSummary:",!!y.summary,"hasTags:",!!y.tag),y):(console.warn("Failed to fetch full actor for:",r.id,"- using minimal actor"),z(r))}catch(l){return console.error("Error processing actor:",r.id,l),z(r)}}));for(const r of s)r.status==="fulfilled"&&r.value&&a.push(r.value);n+t<e.length&&await new Promise(r=>setTimeout(r,0))}return a},Fe=e=>{let t="unknown";try{const a=new URL(e);let n=a.pathname.match(/\/users\/([^/]+)/);if(n)t=n[1];else if(n=a.pathname.match(/\/@([^/]+)/),n)t=n[1];else{const c=a.pathname.split("/").filter(s=>s);c.length>0&&(t=c[c.length-1].replace(/^@/,""))}if(t==="unknown"){const c=a.hostname,s=a.pathname.replace(/^\//,"").replace(/\/$/,"");s&&(t=s.replace(/^@/,"").replace(/\//g,"_"))}}catch(a){console.warn("Failed to parse actor URI:",e,a)}return{"@context":"https://www.w3.org/ns/activitystreams",type:"Person",id:e,preferredUsername:t,name:t,url:e,inbox:`${e}/inbox`,outbox:`${e}/outbox`,followers:`${e}/followers`,following:`${e}/following`,publicKey:{id:`${e}#main-key`,owner:e,publicKeyPem:""},icon:void 0}},ee=async(e,t=0,a=!1)=>{if(!e.trim()){i(A,{actors:[],objects:[]},!0),i(b,new Map,!0),i(j,!1),i(N,!1);return}i(F,!0),i(W,null);try{const n=Array.from(o(ge)),c=new URLSearchParams({q:e,limit:"20",order:o(he),offset:t.toString()});n.length>0&&n.forEach(u=>{c.append("type",u)});const s=await fetch(`/api/search?${c.toString()}`,{headers:{Accept:"application/json"}});if(!s.ok)throw new Error(`Search failed: ${s.status} ${s.statusText}`);const r=await s.json();let l=[];try{l=await ye(r.actors||[])}catch(u){console.error("Error processing actors:",u),r.actors&&Array.isArray(r.actors)&&(l=r.actors.map(y=>z(y)))}a?i(A,{actors:[...o(A).actors,...l],objects:[...o(A).objects,...r.objects||[]]},!0):i(A,{actors:l,objects:r.objects||[]},!0);const d=r.actors.length+r.objects.length;i(N,d>=20)}catch(n){console.error("Search error:",n),i(W,n instanceof Error?n.message:"Search failed",!0),a||(i(A,{actors:[],objects:[]},!0),i(b,new Map,!0),i(j,!1)),i(N,!1)}finally{i(F,!1)}},We=async()=>{var t,a;if(!o(P)||o(F)||o(K)||!o(N))return 0;const e=o(X)+20;i(X,e),i(K,!0),i(W,null);try{const n=Array.from(o(ge)),c=new URLSearchParams({q:o(P),limit:"20",order:o(he),offset:e.toString()});n.length>0&&n.forEach(f=>{c.append("type",f)});const s=await fetch(`/api/search?${c.toString()}`,{headers:{Accept:"application/json"}});if(!s.ok)throw new Error(`Search failed: ${s.status} ${s.statusText}`);const r=await s.json();console.log("LoadMore search results received:",{actors:((t=r.actors)==null?void 0:t.length)||0,objects:((a=r.objects)==null?void 0:a.length)||0});let l=[];try{console.log("About to process actors in loadMore, wasm available:",!!o(v)),l=await ye(r.actors||[]),console.log("Processed actors in loadMore:",l.length)}catch(f){console.error("Error processing actors in loadMore:",f),r.actors&&Array.isArray(r.actors)&&(l=r.actors.map(h=>z(h)))}if(r.objects.length>0&&o(v))for(let h=0;h<r.objects.length;h+=5){const M=r.objects.slice(h,h+5);await Promise.allSettled(M.map(async p=>{try{const m=await be(p);m&&m.note.id&&i(b,new Map(o(b)).set(m.note.id,m),!0)}catch(m){console.error("Error converting object during append:",p.uri,m)}})),await new Promise(p=>setTimeout(p,0))}g=[...o(A).objects.map(f=>f.id),...r.objects.map(f=>f.id)].sort().join(","),i(A,{actors:[...o(A).actors,...l],objects:[...o(A).objects,...r.objects]},!0);const u=r.actors.length+r.objects.length;return i(N,u>=20),o(A).actors.length+o(A).objects.length}catch(n){return console.error("Search error:",n),i(W,n instanceof Error?n.message:"Search failed",!0),i(N,!1),0}finally{i(K,!1)}};let te=null;const we=()=>{te===null&&(te=requestAnimationFrame(async()=>{if(te=null,!o(F)&&!o(K)&&o(N)&&o(P)){const e=document.body.scrollHeight||document.documentElement.scrollHeight;(window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0)+window.innerHeight>=e*.85&&await We()}}))};let re=null,ve=null;B(()=>{const e=Array.from(ue()).sort().join(","),t=fe(),a=re!==null&&(re!==e||ve!==t);re=e,ve=t,a&&o(P)&&(i(X,0),i(N,!0),ee(o(P),0,!1))}),He(()=>{window.addEventListener("scroll",we);const e=pe().url.searchParams.get("q");e&&(i(P,e,!0),ee(e,0,!1))}),B(()=>{const e=pe().url.searchParams.get("q");e&&o(P)!==e&&(i(P,e,!0),ee(e,0,!1))}),Ye(()=>{window.removeEventListener("scroll",we)});let b=C(Pe(new Map)),j=C(!1),g=null,E=null;const $=new Map,oe=new Map;B(()=>{const e=o(A),t=e.objects;if(!o(v)){console.log("WASM not available (not logged in), skipping object conversion"),g=null,i(b,new Map,!0),i(j,!1);return}const a=t.map(f=>f.id).sort().join(","),n=new Set(t.map(f=>f.id));if(console.log("Effect triggered: objects.length=",t.length,"actors.length=",e.actors.length,"currentProcessingIds=",g==null?void 0:g.substring(0,50)),t.length===0){console.log("No objects to convert, clearing displayNotes"),g=null,i(b,new Map,!0),i(j,!1);return}if(g===a&&!o(j)&&o(b).size>0){console.log("Already processed these objects, skipping");return}if(t.length>0&&t.every(f=>o(b).has(f.id))&&o(b).size>=t.length){console.log("All objects already processed directly, skipping effect"),g=a;return}let s=!1,r=null;if(g&&o(b).size>0&&g!==a){r=new Set(Array.from(o(b).keys()));const f=Array.from(r).every(M=>n.has(M)),h=t.length>r.size;s=f&&h,console.log(`Append check: allExistingPresent=${f}, hasNewItems=${h}, existingCount=${r.size}, newCount=${t.length}, isAppending=${s}`)}if(o(j)&&s){console.log("Conversion in progress for append, skipping restart");return}let l=t;if(s&&r&&(l=t.filter(f=>!r.has(f.id)),console.log(`Appending: ${l.length} new objects out of ${t.length} total`)),s&&l.length===0){console.log("All objects already processed, skipping"),g=a;return}if(g!==a)s?console.log("Appending new objects, keeping existing displayNotes"):(console.log("New objects detected (replacement), starting conversion of",t.length,"objects"),console.log("Previous IDs:",(g==null?void 0:g.substring(0,50))||"none"),console.log("New IDs:",a.substring(0,50)),i(b,new Map,!0));else if(o(j)){console.log("Conversion in progress for these objects, skipping restart");return}g=a,s||i(j,!0);const d=a,u=s,y=u?o(b).size:0;(async()=>{console.log("Starting parallel conversion of",l.length,"objects");const f=u?new Map(o(b)):new Map;let h=0;const M=u?l.length:3,p=()=>{(h<=3||h%M===0||h===l.length)&&i(b,new Map(f),!0)};if(!o(v)){console.error("WASM not available, cannot convert objects"),u||i(j,!1);return}console.log("WASM available, processing",l.length,"objects");const m=5,R=async(T,w)=>Promise.allSettled(T.map(async(S,D)=>{const I=w+D;if(g!==d)return null;try{console.log(`[${I}] Converting object:`,S.uri);const _=await be(S);return _&&_.note.id?console.log(`[${I}] Successfully converted object:`,_.note.id):console.log(`[${I}] Failed to convert object:`,S.uri),g===d&&_&&_.note.id?(f.set(_.note.id,_),h++,u?i(b,new Map(o(b)).set(_.note.id,_),!0):p()):g===d&&(h++,u||p()),_}catch(_){return console.error(`[${I}] Error converting object:`,S.uri,_),g===d&&h++,null}}));for(let T=0;T<l.length;T+=m){if(g!==d){console.log("Search canceled, stopping batch processing");break}const w=l.slice(T,T+m);await R(w,T)}if(g!==d){console.log("Conversion canceled: new search started");return}if(o(A).objects.map(T=>T.id).sort().join(",")===d){const T=f.size,w=f.size-y,S=l.length-w;console.log(`Conversion complete: ${T} total notes (${w} new processed), ${S} failed`),u||(i(b,new Map(f),!0),i(j,!1))}else console.log("Search results changed after conversion, discarding results"),u||i(j,!1)})()});let se=Q(()=>(o(b).size,Array.from(o(b).values())));const De=async e=>{if(e&&o(v)){oe.has(e)||oe.set(e,o(v).get_note(e));const t=oe.get(e);return t&&t instanceof Promise?await t:t}};var Ae=lt(),_e=x(Ae);rt(_e,{});var Se=ie(_e,2),ae=H(Se);let je;var Te=H(ae),Ue=H(Te);{var qe=e=>{var t=U(),a=x(t);G(a,16,()=>Array(3),Ce,(n,c)=>{Oe(n)}),O(e,t)},Le=e=>{var t=U(),a=x(t);{var n=s=>{var r=at(),l=H(r,!0);Y(r),le(()=>Me(l,o(W))),O(s,r)},c=s=>{var r=U(),l=x(r);{var d=y=>{var f=nt(),h=H(f);Y(f),le(()=>Me(h,`No results found for "${o(P)??""}"`)),O(y,f)},u=y=>{var f=U(),h=x(f);{var M=p=>{var m=ct(),R=x(m);{var k=w=>{var S=U(),D=x(S);G(D,16,()=>Array(3),Ce,(I,_)=>{Oe(I)}),O(w,S)};q(R,w=>{o(j)&&o(se).length===0&&o(A).objects.length===0&&w(k)})}var ne=ie(R,2);G(ne,17,()=>o(A).actors,w=>w.id,(w,S)=>{tt(w,{get actor(){return o(S)}})});var T=ie(ne,2);G(T,17,()=>o(se),w=>w.note.id,(w,S)=>{var D=U(),I=x(D);{var _=ce=>{et(ce,{get note(){return o(S)},cachedNote:De})};q(I,ce=>{var $e;($e=o(S))!=null&&$e.note&&ce(_)})}O(w,D)}),O(p,m)};q(h,p=>{o(P)&&p(M)},!0)}O(y,f)};q(l,y=>{o(P)&&!o(F)&&!o(j)&&o(A).actors.length===0&&o(se).length===0?y(d):y(u,!1)},!0)}O(s,r)};q(a,s=>{o(W)?s(n):s(c,!1)},!0)}O(e,t)};q(Ue,e=>{o(F)?e(qe):e(Le,!1)})}Y(Te),Y(ae),Y(Se),le(()=>je=Ke(ae,1,"content svelte-e12qt1",null,je,{"filters-hidden":!o(V)&&!de()})),O(Ee,Ae),Je(),Re()}export{Tt as component};
